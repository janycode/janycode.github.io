

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jerry(姜源)">
  <meta name="keywords" content="Java,Html,CSS,JavaScript,Python,C,Linux,shell编程经验分享、技术总结、心得体会">
  
    <meta name="description" content="欲速则不达，欲达则欲速！ —— 佚名  性能优化更多要求我们关注整体效果，兼顾可靠性、扩展性，以及极端的异常场景。  1. 理论分析1.1 衡量指标 吞吐量和响应速度吞吐量：  QPS 每秒查询数量，TPS 每秒事务数量，HPS 每秒HTTP请求数量 并行执行的优化，合理利用计算资源达到目标  响应速度：  Time 时间 串行执行的优化，优化执行步骤解决问题 响应速度提升，吞吐量也就跟着提升了">
<meta property="og:type" content="article">
<meta property="og:title" content="04-Java性能优化实战">
<meta property="og:url" content="https://janycode.github.io/2023/04/15/16_%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01_Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/04-Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="姜源の云笔记">
<meta property="og:description" content="欲速则不达，欲达则欲速！ —— 佚名  性能优化更多要求我们关注整体效果，兼顾可靠性、扩展性，以及极端的异常场景。  1. 理论分析1.1 衡量指标 吞吐量和响应速度吞吐量：  QPS 每秒查询数量，TPS 每秒事务数量，HPS 每秒HTTP请求数量 并行执行的优化，合理利用计算资源达到目标  响应速度：  Time 时间 串行执行的优化，优化执行步骤解决问题 响应速度提升，吞吐量也就跟着提升了">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715210354.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715211915.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715212212.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213411.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213931.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213954.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715214552.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235645.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215007.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215514.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215451.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215635.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215817.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715220428.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715224644.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715222057.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235602.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225528.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225939.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225914.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232122.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232250.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232312.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715233815.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716213712.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717001346.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716234609.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235302.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717000858.png">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717001504.png">
<meta property="article:published_time" content="2023-04-15T12:55:50.000Z">
<meta property="article:modified_time" content="2023-12-24T03:11:24.621Z">
<meta property="article:author" content="Jerry(姜源)">
<meta property="article:tag" content="JavaSE">
<meta property="article:tag" content="性能优化">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715210354.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>04-Java性能优化实战 - 姜源の云笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"janycode.github.io","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":50,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"bfff735c897eb60ea49b735096b20e47","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>姜源の云笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tools/">
                <i class="iconfont icon-slack-fill"></i>
                工具
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://yuancodes.github.io/">
                <i class="iconfont icon-notebook"></i>
                Docsify
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="04-Java性能优化实战"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Jerry(姜源)
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-15 20:55" pubdate>
          星期六, 2023/04/15 20:55:50
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          67 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">04-Java性能优化实战</h1>
            
            <div class="markdown-body">
              
              <p><code>欲速则不达，欲达则欲速！</code> —— 佚名</p>
<blockquote>
<p>性能优化更多要求我们关注整体效果，兼顾可靠性、扩展性，以及极端的异常场景。</p>
</blockquote>
<h3 id="1-理论分析"><a href="#1-理论分析" class="headerlink" title="1. 理论分析"></a>1. 理论分析</h3><h4 id="1-1-衡量指标"><a href="#1-1-衡量指标" class="headerlink" title="1.1 衡量指标"></a>1.1 衡量指标</h4><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715210354.png" srcset="/img/loading.gif" lazyload alt="image-20230715210352930"></p>
<h5 id="吞吐量和响应速度"><a href="#吞吐量和响应速度" class="headerlink" title="吞吐量和响应速度"></a>吞吐量和响应速度</h5><p><code>吞吐量</code>：</p>
<ul>
<li>QPS 每秒查询数量，TPS 每秒事务数量，HPS 每秒HTTP请求数量</li>
<li>并行执行的优化，合理利用计算资源达到目标</li>
</ul>
<p><code>响应速度</code>：</p>
<ul>
<li>Time 时间</li>
<li>串行执行的优化，优化执行步骤解决问题</li>
<li>响应速度提升，吞吐量也就跟着提升了</li>
</ul>
<h5 id="响应时间衡量"><a href="#响应时间衡量" class="headerlink" title="响应时间衡量"></a>响应时间衡量</h5><p><code>平均响应时间</code></p>
<h5 id="并发量"><a href="#并发量" class="headerlink" title="并发量"></a>并发量</h5><p>同时能为多个用户提供服务的能力。</p>
<h4 id="1-2-常用理论"><a href="#1-2-常用理论" class="headerlink" title="1.2 常用理论"></a>1.2 常用理论</h4><h5 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h5><p>基准测试（Benchmark），测试某个程序的最佳性能。</p>
<p>测试之前，对应用进行预热，消除JIT编译器等因素的影响，java组件 JMH 就可以消除这些差异。</p>
<h5 id="木桶理论"><a href="#木桶理论" class="headerlink" title="木桶理论"></a>木桶理论</h5><p>木桶理论：<code>系统整体的性能，取决于系统重最慢的组件</code>。</p>
<p>比如数据库应用中，制约性能最严重的就是<code>磁盘I/O问题</code>，硬盘是短板，也就是需要补齐这个短板。</p>
<h4 id="1-3-注意点"><a href="#1-3-注意点" class="headerlink" title="1.3 注意点"></a>1.3 注意点</h4><ul>
<li>数字说话而不是猜想<ul>
<li>根据难度和影响程度：击破影响最大的点，将其他因素逐一击破</li>
</ul>
</li>
<li>个体数据不足信<ul>
<li>小批量数据的场景，需要有响应之间直方图去分析</li>
</ul>
</li>
<li>不要过早优化和过度优化<ul>
<li>项目开发和性能优化，要作为两个独立的步骤进行，<code>性能优化在项目功能大体进入稳定状态时在进行</code></li>
</ul>
</li>
<li>保持良好编码习惯<ul>
<li>好的编码习惯、合适的设计模式</li>
</ul>
</li>
</ul>
<h4 id="1-4-七类手段"><a href="#1-4-七类手段" class="headerlink" title="1.4 七类手段"></a>1.4 七类手段</h4><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715211915.png" srcset="/img/loading.gif" lazyload alt="image-20230715211914862"></p>
<h5 id="复用优化"><a href="#复用优化" class="headerlink" title="复用优化"></a>复用优化</h5><p>代码：重复代码提取。</p>
<p>数据：数据复用，<strong>缓冲 Buffer</strong> - 主要针对写操作、缓存 Cache - 主要针对读操作</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715212212.png" srcset="/img/loading.gif" lazyload alt="image-20230715212211442"></p>
<h5 id="计算优化"><a href="#计算优化" class="headerlink" title="计算优化"></a>计算优化</h5><p>并行执行：多机、多进程、多线程</p>
<p>同步变异步：涉及编程逻辑的改变</p>
<p>惰性加载：需要时才加载。</p>
<h5 id="结果集优化"><a href="#结果集优化" class="headerlink" title="结果集优化"></a>结果集优化</h5><p>数据：传输数据的效率和解析率的提高，如 JSON 、ProtoBuf</p>
<p>压缩：Nginx 和 feign 的 Gzip 压缩，使传输内容保持紧凑</p>
<p>批量：时效要求不高，处理能力有高要求的情况</p>
<h5 id="资源冲突优化"><a href="#资源冲突优化" class="headerlink" title="资源冲突优化"></a>资源冲突优化</h5><p>锁：乐观锁效率更高</p>
<h5 id="算法优化"><a href="#算法优化" class="headerlink" title="算法优化"></a>算法优化</h5><p>空间换时间：CPU紧张的业务中，空间换时间的方式提高性能</p>
<p>算法本身：采用降低时间负责度的算法，递归、二分、排序、动态规划等</p>
<h5 id="高效实现"><a href="#高效实现" class="headerlink" title="高效实现"></a>高效实现</h5><p>组件：使用高性能组件，如长连接 netty 等</p>
<h5 id="JVM-优化"><a href="#JVM-优化" class="headerlink" title="JVM 优化"></a>JVM 优化</h5><p>垃圾回收器：广泛使用的是 G1</p>
<h4 id="1-5-性能瓶颈"><a href="#1-5-性能瓶颈" class="headerlink" title="1.5 性能瓶颈"></a>1.5 性能瓶颈</h4><h5 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h5><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213411.png" srcset="/img/loading.gif" lazyload alt="image-20230715213410412"></p>
<p>top 命令：CPU 占用情况查看。</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213931.png" srcset="/img/loading.gif" lazyload alt="image-20230715213930562"></p>
<p>uptime 命令：查看负载情况，分别显示 1min、5min、15min的数值。</p>
<p>vmstat 命令：CPU 繁忙程度查看。</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715213954.png" srcset="/img/loading.gif" lazyload alt="image-20230715213953670"></p>
<blockquote>
<p>每个进程上下文切换的具体数量，查看内存映射文件获取：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#进程id 2788</span><br>[root@localhost~]<span class="hljs-comment"># cat /proc/2788/status</span><br>...<br>voluntary_ctxt_switches: 93950<br>nonvoluntary_ctxt_switches: 171204<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h5><p>一些程序的默认行为会对性能有所影响，比如JVM的 <code>-XX:+AlwaysPreTouch</code> 参数。默认情况下，JVM虽然配置了Xmx、Xms等参数,指定堆的初始化大小和最大大小。如果加上 AlwaysPreTouch，JVM会在启动的时候，把所有的内存预先分配。</p>
<h5 id="I-x2F-O"><a href="#I-x2F-O" class="headerlink" title="I&#x2F;O"></a>I&#x2F;O</h5><p>缓冲区：解决速度差异的唯一工具。</p>
<p><code>iostat</code> 命令：查看磁盘I&#x2F;O情况的工具。</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715214552.png" srcset="/img/loading.gif" lazyload alt="image-20230715214551696"></p>
<p>零拷贝：非常重要的性能优化手段，如kafka、Nginx都使用了这种手段。</p>
<h3 id="2-工具支持"><a href="#2-工具支持" class="headerlink" title="2. 工具支持"></a>2. 工具支持</h3><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235645.png" srcset="/img/loading.gif" lazyload alt="image-20230716235644294"></p>
<h4 id="2-1-nmon-获取系统性能数据"><a href="#2-1-nmon-获取系统性能数据" class="headerlink" title="2.1 nmon 获取系统性能数据"></a>2.1 nmon 获取系统性能数据</h4><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215007.png" srcset="/img/loading.gif" lazyload alt="image-20230715215007008"></p>
<p>选择对应的版本，如 .&#x2F;nmon_x86_64_centos7</p>
<ul>
<li>按 C 可以加入 CPU 面板</li>
<li>按 M 可以加入 内存 面板</li>
<li>按 N 可以加入 网络 面板</li>
<li>按 D 可以加入 磁盘 面板</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#每5s采集一次数据，共采集12次</span><br>./nmon_x86_64_centos7 -f -s 5 -c 12 -m -m .<br></code></pre></td></tr></table></figure>

<p>监控：最流行的组合是 <code>prometheus + grafana + telegraf</code> 搭建功能强大的监控平台。</p>
<h4 id="2-2-jvisualvm-获取JVM性能数据"><a href="#2-2-jvisualvm-获取JVM性能数据" class="headerlink" title="2.2 jvisualvm 获取JVM性能数据"></a>2.2 jvisualvm 获取JVM性能数据</h4><p>插件上加入 jmx 参数：</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215514.png" srcset="/img/loading.gif" lazyload alt="image-20230715215508976"></p>
<p>参数的含义：在 14000 端口上开启 jmx，同时不需要 ssl</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215451.png" srcset="/img/loading.gif" lazyload alt="image-20230715215450393"></p>
<h4 id="2-3-jmc-获取java应用详细性能数据"><a href="#2-3-jmc-获取java应用详细性能数据" class="headerlink" title="2.3 jmc 获取java应用详细性能数据"></a>2.3 jmc 获取java应用详细性能数据</h4><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215635.png" srcset="/img/loading.gif" lazyload alt="image-20230715215632189"></p>
<p>录制1分钟后查看线程的执行情况：</p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715215817.png" srcset="/img/loading.gif" lazyload alt="image-20230715215801949"></p>
<h4 id="2-4-arthas-获取单个请求的调用链耗时"><a href="#2-4-arthas-获取单个请求的调用链耗时" class="headerlink" title="2.4 arthas 获取单个请求的调用链耗时"></a>2.4 arthas 获取单个请求的调用链耗时</h4><p>主要使用 <code>trace</code> 命令，参考：<a target="_blank" rel="noopener" href="https://janycode.gitee.io/#/./09_%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/05_%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/02-Arthas%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7?id=arthas%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7">Arthas阿里开源诊断工具</a></p>
<h4 id="2-5-wrk-获取web接口的性能数据"><a href="#2-5-wrk-获取web接口的性能数据" class="headerlink" title="2.5 wrk 获取web接口的性能数据"></a>2.5 wrk 获取web接口的性能数据</h4><p>HTTP 压测工具，和 ab命令类似，命令行工具，参考：<a target="_blank" rel="noopener" href="https://github.com/wg/wrk">https://github.com/wg/wrk</a></p>
<p>扩展：jmeter 是专业的压测工具，可以生成压测报告。</p>
<h4 id="2-6-java-JMH-精准测量方法性能"><a href="#2-6-java-JMH-精准测量方法性能" class="headerlink" title="2.6 java JMH 精准测量方法性能"></a>2.6 java JMH 精准测量方法性能</h4><blockquote>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715220428.png" srcset="/img/loading.gif" lazyload alt="image-20230715220428006"></p>
<p>如上图常用的java代码耗时计算，但并不是一定准确。因为 JVM执行时，会对一些代码或频繁执行的逻辑，进行 JIT编译和内联优化，在得到一个稳定的测试结果之前，需要先循环上万次进行预热。</p>
</blockquote>
<p><code>JMH</code> (the Java Microbenchmark Harness) 基准测试的工具，测量精读非常高，可达<code>纳秒</code>级别。它已经在 JDK12 中被默认包含，其他版本需要单独引入。</p>
<p>使用参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/54chensongxia/p/15485421.html">https://www.cnblogs.com/54chensongxia/p/15485421.html</a></p>
<p>官方示例：<a target="_blank" rel="noopener" href="https://hg.openjdk.org/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/">https://hg.openjdk.org/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/</a></p>
<p>使用前需引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jmh<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jmh-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jmh<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> jmh; <span class="hljs-comment">//@Benchmark 注解必须用于在确定的包目录下，此行不能为空</span><br><br><span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.Benchmark;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.results.format.ResultFormatType;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.Runner;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.RunnerException;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.options.Options;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestJMH</span> &#123;<br><br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">wellHelloThere</span><span class="hljs-params">()</span> &#123;<br>        System.out.print(<span class="hljs-string">&quot;Hello,world.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RunnerException &#123;<br>        <span class="hljs-type">Options</span> <span class="hljs-variable">opt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptionsBuilder</span>()<br>                .include(TestJMH.class.getSimpleName())<br>                .forks(<span class="hljs-number">1</span>)<br>                .resultFormat(ResultFormatType.JSON)  <span class="hljs-comment">//指定结果的文件输出格式，用于图形化展示</span><br>                .build();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runner</span>(opt).run();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>图形化结果：<code>jmh-result.json</code> 文件</p>
<p><a target="_blank" rel="noopener" href="https://jmh.morethan.io/">https://jmh.morethan.io/</a></p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715224644.png" srcset="/img/loading.gif" lazyload alt="image-20230715224643981"></p>
<p>常用注解：</p>
<ul>
<li>@Warmup：预热所需要配置的一些基本测试参数，可用于类或者方法上。</li>
<li>@Measurement：实际调用方法所需要配置的一些基本测试参数，可用于类或者方法上，参数和 <code>@Warmup</code> 相同。</li>
<li>@BenchmarkMode：用来配置 Mode 选项，可用于类或者方法上，这个注解的 value 是一个数组，可以把几种 Mode 集合在一起执行，如：<code>@BenchmarkMode(&#123;Mode.SampleTime, Mode.AverageTime&#125;)</code>，还可以设置为 <code>Mode.All</code>，即全部执行一遍。</li>
<li>@OutputTimeUnit：为统计结果的时间单位，可用于类或者方法注解。</li>
<li>@Fork：进行 fork 的次数，可用于类或者方法上。一般设置为 1 只使用一个进程进行测试；如果 fork 数是 2 的话，则 JMH 会 fork 出两个进程来进行测试。<code>独立的进程进行测试的，环境数据隔离。</code> 它也可以通过 jvmArgsAppend 参数来传入 JVM 参数。</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715222057.png" srcset="/img/loading.gif" lazyload alt="image-20230715222055856"></p>
<ul>
<li>@Threads：每个进程中的测试线程，可用于类或者方法上。如果配置了 Threads.MAX 则使用和处理机器核数相同的线程数。</li>
<li>@State：通过 State 可以指定一个对象的作用范围，JMH 根据 scope 来进行实例化和共享操作。</li>
<li>@Param：指定某项参数的多种情况，特别适合用来测试一个函数在不同的参数输入的情况下的性能，只能作用在字段上，使用该注解必须定义 @State 注解。</li>
</ul>
<p>常用示例 - 输出耗时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.*;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span><br><span class="hljs-meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBenchmark</span> &#123;<br><br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 要测试耗时的方法逻辑</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        org.openjdk.jmh.Main.main(args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用<code>@BenchmarkMode</code>注解，将测试模式设置为<code>Mode.AverageTime</code>，表示测试方法的耗时为平均时间。然后使用<code>@OutputTimeUnit</code>注解，将输出时间单位设置为<code>TimeUnit.MILLISECONDS</code>，表示以毫秒为单位输出耗时。</p>
<p>在运行该示例代码时，控制台输出将显示每个操作的平均耗时（<strong>ms&#x2F;ops</strong>）。</p>
<h4 id="2-7-性能深挖工具"><a href="#2-7-性能深挖工具" class="headerlink" title="2.7 性能深挖工具"></a>2.7 性能深挖工具</h4><p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235602.png" srcset="/img/loading.gif" lazyload alt="image-20230716235601629"></p>
<h3 id="3-代码性能优化"><a href="#3-代码性能优化" class="headerlink" title="3. 代码性能优化"></a>3. 代码性能优化</h3><h4 id="3-1-缓冲-buffer"><a href="#3-1-缓冲-buffer" class="headerlink" title="3.1 缓冲 buffer"></a>3.1 缓冲 buffer</h4><p>Buffer 缓冲：数据一般只使用一次，等待缓冲区满了，就执行 flush 操作。</p>
<p>如 JVM 的堆，就是一个缓冲的概念，代码在堆中不停的生成对象，垃圾回收器在堆中回收。</p>
<p><strong>文件读写流</strong>：</p>
<ul>
<li>缓冲保存在内存中，显著提升读写速度，折中的值是 8k，也就是 8192 字节。</li>
</ul>
<p><strong>日志缓冲</strong>：</p>
<ul>
<li>高速日志组件 SLF4J 实现的 Logback，缓冲队列实现异步日志</li>
<li>Logback 异步日志配置：</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225528.png" srcset="/img/loading.gif" lazyload alt="image-20230715225527191"></p>
<p>★★★★★<code>缓冲区优化思路</code>：</p>
<ol>
<li>同步操作：控制缓冲区大小，把握处理的时机</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225939.png" srcset="/img/loading.gif" lazyload alt="image-20230715225938872"></p>
<ol start="2">
<li>异步操作：多线程，等待线程超时策略，异步回调函数</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715225914.png" srcset="/img/loading.gif" lazyload alt="image-20230715225913963"></p>
<ol start="3">
<li>StringBuilder 和 StringBuffer：将要处理的字符串缓冲起来，提高拼接性能</li>
<li>flush函数强制刷新数据：在写入磁盘或网络I&#x2F;O时</li>
<li>MySQL的InnoDB中，配置合理的 innodb_buffer_pool_size 来减少换页，增加数据库的性能</li>
</ol>
<blockquote>
<p>注意事项：</p>
<p>内容写入缓冲区前，需要<code>先预写日志</code>，断电&#x2F;异常退出&#x2F;kill -9时等故障重启时，根据日志进行数据恢复。</p>
</blockquote>
<h4 id="3-2-缓存-cache"><a href="#3-2-缓存-cache" class="headerlink" title="3.2 缓存 cache"></a>3.2 缓存 cache</h4><p>缓存 Cache：数据被载入之后，可以多次使用，数据将会共享多次。</p>
<p>缓存的指标：命中率。</p>
<p>影响命中率的因素：</p>
<ul>
<li>缓存容量</li>
<li>数据集类型</li>
<li>缓存失效策略</li>
</ul>
<p><code>本地缓存</code> （堆内缓存）</p>
<p>推荐比如 Guava 的 LoadingCache(LC)，是堆内缓存工具。也可以理解为 本地缓存。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>29.0-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>具体使用参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3d546868a1db">https://www.jianshu.com/p/3d546868a1db</a></p>
<p><code>分布式缓存</code>（Redis）</p>
<p>java的Redis客户端 jedis、redisson、lettuce(Spring默认使用的是lettuce)</p>
<ul>
<li>引入 spring-boot-starter-data-redis 时，使用 redisTemplate.opsXxx 方法操作缓存</li>
<li>引入 spring-boot-starter-cache 时，使用注解+AOP方式，可以在堆内缓存和分布式缓存之间切换<ul>
<li>启动类加 @EnableCaching </li>
<li>@CacheConfig 注解注入要使用的缓存框架</li>
<li>@Cacheable 对资源进行缓存<ul>
<li>@Cacheable 缓存里没有，则将方法返回值进行缓存</li>
<li>@CachePut 每次执行该方法，都将返回值缓存起来</li>
<li>@CacheEvict 执行方法的时候，清除某些缓存值</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>示例：秒杀业务处理</strong></p>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232122.png" srcset="/img/loading.gif" lazyload alt="image-20230715232121924"></p>
<ul>
<li>Lua 脚本完成秒杀：解决同步问题</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232250.png" srcset="/img/loading.gif" lazyload alt="image-20230715232249700"></p>
<ul>
<li>秒杀代码</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715232312.png" srcset="/img/loading.gif" lazyload alt="image-20230715232311717"></p>
<blockquote>
<p>注意事项：</p>
<p>缓存一致性问题：懒加载的方式。</p>
<ul>
<li>读缓存时无缓存数据则执行业务逻辑载入缓存</li>
<li>与缓存有关的资源变动时，先删除相应的缓存项，再对资源进行更新（此时即使资源更新失败也没问题）</li>
</ul>
</blockquote>
<h4 id="3-3-池化对象-pool"><a href="#3-3-池化对象-pool" class="headerlink" title="3.3 池化对象 pool"></a>3.3 池化对象 pool</h4><p><code>连接池</code></p>
<p>公共池化包 Commons Pool 2.0</p>
<ul>
<li>Jedis 是在 Commons Pool 2.0 的基础上封装的。</li>
<li>HikariCP 是数据库连接池中速度最快的。</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230715233815.png" srcset="/img/loading.gif" lazyload alt="image-20230715233814995"></p>
<p>常见连接池 http连接池、RPC使用连接池技术、Dubbo连接池技术等…</p>
<h4 id="3-4-大对象复用-obj"><a href="#3-4-大对象复用-obj" class="headerlink" title="3.4 大对象复用 obj"></a>3.4 大对象复用 obj</h4><p>占用资源多，垃圾回收花费时间递增；网络I&#x2F;O变大；解析和处理耗时高。</p>
<ul>
<li><p><strong>大对象回收</strong>：切断与大对象的引用关系，便于让大对象及时回收。</p>
</li>
<li><p><strong>集合大对象扩容</strong>：初始化容量的考量关联扩容因子来设计。</p>
</li>
<li><p><strong>保持合适的对象粒度</strong>：对象存储缓存的时候，使用 hash 结构代替 JSON 结构，加快字段获取和信息流转速度。</p>
</li>
<li><p><strong>Bitmap 把对象变小</strong>：100亿的 Boolean 数据只占128M内存，java虚拟机中对 Boolean 和 int 一样都是 32位。</p>
</li>
<li><p><strong>数据的冷热分离</strong>：数据的时间维度划分。数据双写、写入MQ分发冷热库、使用Binlog同步(Canal组件结合MQ)</p>
</li>
</ul>
<h4 id="3-5-设计模式-design"><a href="#3-5-设计模式-design" class="headerlink" title="3.5 设计模式 design"></a>3.5 设计模式 design</h4><p>和性能相关的几个设计模式：代理模式、单例模式、享元模式、原型模式…</p>
<ul>
<li><p><strong>代理模式</strong>：jdk方式 和 cglib 的创建和执行差别不大，spring选择 cglib是因为可以代理普通类。</p>
</li>
<li><p><strong>单例模式</strong>：double check 双检锁单例，兼顾安全和效率，不推荐使用。推荐枚举实现懒加载的单例。</p>
</li>
<li><p><strong>享元模式</strong>：共享技术最大限度复用对象。对象复用角度属于 享元模式，功能角度属于 策略模式。</p>
</li>
<li><p><strong>原型模式</strong>：加快创建对象的一种思想。</p>
</li>
</ul>
<p>对性能帮助最大的是 <code>生产者消费者模式</code>，比如异步消息、reactor模型等…</p>
<h4 id="3-6-多线程-threads"><a href="#3-6-多线程-threads" class="headerlink" title="3.6 多线程 threads"></a>3.6 多线程 threads</h4><p><code>使用线程池</code> ：<a target="_blank" rel="noopener" href="https://janycode.gitee.io/#/./02_%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/01_Java/01_JavaSE/05_%E5%B9%B6%E5%8F%91%E5%92%8C%E9%94%81/08-%E7%BA%BF%E7%A8%8B%E6%B1%A0ThreadPoolExecutor">ThreadPoolExector</a></p>
<ul>
<li><p>I&#x2F;O密集型：核心线程数量 &#x3D; I&#x2F;O任务的数量，最大线程数 &#x3D; 核心线程数 × 2，效果是最好的。在充分利用CPU资源的同时，确保有足够的线程来处理业务逻辑。</p>
</li>
<li><p>CPU密集型：核心线程数量 &#x3D; CPU核数，最大线程数 &#x3D; 核心线程数，效率是最高的。因为任务之间切换少，可以充分压榨CPU的计算性能。</p>
</li>
</ul>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716213712.png" srcset="/img/loading.gif" lazyload alt="image-20230716213710862"></p>
<p>使用线程池：SpringBoot启动类上加 @EnableAsync 注解，在具体的方法上加 @Async(“线程池bean”)</p>
<blockquote>
<p>注意事项：</p>
<ul>
<li>多线程中，如果抛出了异常，该异常没有被 try-catch 则会导致该线程异常中止。</li>
</ul>
</blockquote>
<h4 id="3-7-SpringBoot服务性能优化"><a href="#3-7-SpringBoot服务性能优化" class="headerlink" title="3.7 SpringBoot服务性能优化"></a>3.7 SpringBoot服务性能优化</h4><ol>
<li>在 SpringBoot 的配置文件中，通过如下配置开启 gzip，对结果集去除无用的信息和合理的压缩来提高性能。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">compression:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">min-response-size:</span> <span class="hljs-number">1024</span><br>    <span class="hljs-attr">mime-types:</span> [<span class="hljs-string">&quot;text/html&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>]<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>同时针对 feign 的底层网络工具改为 <code>OkHTTP</code>，使用 OkHTTP 的透明压缩（默认开启 gzip），即可完成服务间调用的信息压缩。</p>
</li>
<li><p>将结果集合并，使用批量的方式，可以显著增加性能</p>
</li>
</ol>
<h4 id="3-8-代码优化法则"><a href="#3-8-代码优化法则" class="headerlink" title="3.8 代码优化法则"></a>3.8 代码优化法则</h4><ol>
<li><code>使用局部变量可避免在堆上分配</code>：堆资源是多线程共享的，过多的对象会造成GC压力，局部变量的方式，将变量在栈上分配。</li>
<li><code>减少变量的作用范围</code>：除了循环中。</li>
<li><code>访问静态变量直接使用类名</code>：对象操作会增加寻址操作。</li>
<li><code>字符串拼接</code>：使用 StringBuilder 或 StringBuffer，不要使用 + 号。</li>
<li><code>重写对象的 HashCode，不要简单的返回固定值</code>：固定返回 0 相当于把 hash 寻址的功能废除了。</li>
<li><code>HashMap 等集合初始化的时候，指定初始值大小</code>：大对象的复用，减少扩容带来的损耗。</li>
<li><code>遍历 Map 的时候使用 EntrySet 方法</code>：比 KeySet 步骤更少。</li>
<li><code>不要在多线程下使用同一个 Random</code>：Random类的seed会在并发访问的情况下发生竞争，造成性能降低。建议在多线程环境下使用 <code>ThreaLocalRandom</code> 类。也可以通过 JVM 配置加入 <code>-Djava.security.egd=file:/dev/./urandom</code> 使用 urandom 随机生成器，在随机数获取时，速度会更快。</li>
<li><code>自增推荐使用 LongAddr</code>：也可以使用原子类 AtomicLong。</li>
<li><code>不要使用异常控制程序流程</code>：异常比条件判断更消耗资源。</li>
<li><code>不要在循环中使用 try-catch</code>：应该放在最外层。</li>
<li><code>不要捕捉 RuntimeException</code>：应该在编码层面就要解决掉。</li>
<li><code>合理使用 PreparedStatement</code>：预编译对 SQL 进行提速。</li>
<li><code>日志打印注意事项-占位符</code>：使用占位符的方式提高日志的性能，</li>
<li><code>减少事务的作用范围</code>：事务的隔离性使用锁实现的，锁对性能有损耗。</li>
<li><code>使用位移操作代替乘除法</code>：位移操作会极大提高性能。</li>
<li><code>不要打印大集合或大集合的toString方法</code>：非常不好的习惯，占用大量的内存 I&#x2F;O。</li>
<li><code>程序中少用反射</code>：反射通过解析字节码实现的，性能不太理想。</li>
<li><code>正则表达式可以预先编译，加快速度</code>：Pattern 可以作为类的静态变量使用来预编译。</li>
<li>… 参考汇总图</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717001346.png" srcset="/img/loading.gif" lazyload alt="image-20230717001345505"></p>
<h3 id="4-JVM虚拟机优化"><a href="#4-JVM虚拟机优化" class="headerlink" title="4. JVM虚拟机优化"></a>4. JVM虚拟机优化</h3><p>参考1：<a target="_blank" rel="noopener" href="https://janycode.gitee.io/#/./07_%E8%99%9A%E6%8B%9F%E6%9C%BA/04-JVM%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98?id=jvm%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98">JVM参数调优</a></p>
<p>参考2：<a target="_blank" rel="noopener" href="https://janycode.gitee.io/#/./07_%E8%99%9A%E6%8B%9F%E6%9C%BA/06-4Cpu8G%E7%9A%84JVM%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%A1%88?id=_4cpu8g%E7%9A%84jvm%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%A1%88">4Cpu8G的JVM参数设置方案</a></p>
<h3 id="5-性能优化过程方法"><a href="#5-性能优化过程方法" class="headerlink" title="5. 性能优化过程方法"></a>5. 性能优化过程方法</h3><ol>
<li>优化目标</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716234609.png" srcset="/img/loading.gif" lazyload alt="image-20230716234608573"></p>
<ol start="2">
<li>核心维度</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230716235302.png" srcset="/img/loading.gif" lazyload alt="image-20230716235301196"></p>
<ul>
<li><p>CPU</p>
<ul>
<li>top 命令，注意它的负载 load 和 使用率。比如 <code>top -Hp</code> 便能很容易获取占用 CPU 最高的线程，进行针对性的优化。</li>
<li>vmstat 命令，也可以看到一些运行状况，如上下文切换和swap交换分区使用情况。</li>
</ul>
</li>
<li><p>内存</p>
<ul>
<li>free 命令，关注剩余内存的大小 free。</li>
<li>top 命令，RES 列显示的就是进程实际占用的物理内存。</li>
</ul>
</li>
<li><p>网络I&#x2F;O</p>
<ul>
<li>iotop 命令，可以看到占用 I&#x2F;O 最多的进程。</li>
<li>netstat 命令 或 ss 命令，可以看到当前机器上的网络连接汇总。</li>
<li>iostat 命令，可以查看磁盘 I&#x2F;O 的使用情况。</li>
</ul>
</li>
<li><p>通用</p>
<ul>
<li>lsof 命令，可以查看当前进程所关联的所有资源。</li>
<li>sysctl 命令，可以查看当前系统内核的配置参数。</li>
<li>dmesg 命令，可以显示系统级别的一些信息。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>基本解决方式</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717000858.png" srcset="/img/loading.gif" lazyload alt="image-20230717000857067"></p>
<ol start="4">
<li>PDCA 循环方法论</li>
</ol>
<p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20230717001504.png" srcset="/img/loading.gif" lazyload alt="image-20230717001504042"></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/16-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="category-chain-item">16_性能优化</a>
  
  
    <span>></span>
    
  <a href="/categories/16-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01-Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="category-chain-item">01_Java性能优化</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/JavaSE/">#JavaSE</a>
      
        <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">#性能优化</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>04-Java性能优化实战</div>
      <div>https://janycode.github.io/2023/04/15/16_性能优化/01_Java性能优化/04-Java性能优化实战/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Jerry(姜源)</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月15日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 姜源">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/20/13_%E7%AC%AC%E4%B8%89%E6%96%B9/03_OpenAI/01-%E6%8E%A5%E5%85%A5chatGPT%20API/" title="01-接入chatGPT API">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">01-接入chatGPT API</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/07/16_%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01_Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/03-12%E7%A7%8D%E4%BC%98%E9%9B%85%E7%9A%84%E6%8E%A5%E5%8F%A3%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/" title="03-12种优雅的接口优化方案">
                        <span class="hidden-mobile">03-12种优雅的接口优化方案</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="SOHUCS" sid='https://janycode.github.io/2023/04/15/16_%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01_Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/04-Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/'></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#SOHUCS', function() {
      Fluid.utils.createScript("https://changyan.sohu.com/upload/changyan.js", function() {
        window.changyan.api.config({"appid":"cyw5OHIcO","appkey":"fea3446b3df4b3f129f34da4cbc87e51"})
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://simple.blog.csdn.net" target="_blank" rel="nofollow noopener"><span>CSDN</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/janycode" target="_blank" rel="nofollow noopener"><span>GitHub</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量(PV) 
        <span id="busuanzi_value_site_pv"></span>
         次，
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数(UV) 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

<!-- live2d 动画 -->
<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script>
<script>
    L2Dwidget.init({
        "model": {
            jsonPath: "https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
            "scale": 1
        },
        "display": {
            "position": "right",
            "width": 100,
            "height": 200,
            "hOffset": 35,
            "vOffset": -85
        },
        "mobile": {
            "show": false,
            "scale": 0.1
        },
        "react": {
            "opacityDefault": 0.75,
            "opacityOnHover": 0.2
        }
    });
</script>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?bfff735c897eb60ea49b735096b20e47";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
