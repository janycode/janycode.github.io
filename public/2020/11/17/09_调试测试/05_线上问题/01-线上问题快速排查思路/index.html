

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jerry(姜源)">
  <meta name="keywords" content="Java,Html,CSS,JavaScript,Python,C,Linux,shell编程经验分享、技术总结、心得体会">
  
    <meta name="description" content="线上定位问题时，主要靠监控和日志。一旦超出监控的范围，则排查思路很重要，按照流程化的思路来定位问题，能够让我们在定位问题时从容、淡定，快速的定位到线上的问题。  线上问题定位思维导图 一 服务器层面1.1 磁盘1.1.1 问题现象当磁盘容量不足的时候，应用时常会抛出如下的异常信息： 1java.io.IOException: 磁盘空间不足  或是类似如下告警信息： 1.1.2 排查思路1.1.2">
<meta property="og:type" content="article">
<meta property="og:title" content="01-线上问题快速排查思路">
<meta property="og:url" content="https://janycode.github.io/2020/11/17/09_%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/05_%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/01-%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%BF%AB%E9%80%9F%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/index.html">
<meta property="og:site_name" content="姜源の云笔记">
<meta property="og:description" content="线上定位问题时，主要靠监控和日志。一旦超出监控的范围，则排查思路很重要，按照流程化的思路来定位问题，能够让我们在定位问题时从容、淡定，快速的定位到线上的问题。  线上问题定位思维导图 一 服务器层面1.1 磁盘1.1.1 问题现象当磁盘容量不足的时候，应用时常会抛出如下的异常信息： 1java.io.IOException: 磁盘空间不足  或是类似如下告警信息： 1.1.2 排查思路1.1.2">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20201117222659.png">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/046450040354435cb5fc34e1e885f4b8.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/368a1ed9ffc84883a43f668f70e43c0e.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/a3ffed5571434523a1fdf88b3d6929c9.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/30bd3f18a45346cdb9a16d093ebee9f4.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/8609b9a4431b4f0ab8b5ffa5d275b25c.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/31b80090624248009a926ae490ee8129.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/cc3a8d71acb14eb58fc6d10bb505811a.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/e732d7cb94984eadb99043f934338c7f.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/48fa0478bef54d9f9a85a6e4bad340ab.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/214e3676a08244e6bea119bd3a1cf821.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/5c1439d594c7455cb29cdb112464fff4.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/82d681f48f7e4bf4b3fcd60b3d4de2e5.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/8568dab2768d41b38dc4e08f57e5f6e6.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/5dd23103e55d49a3b92ef5319294e71b.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/41ca38d4ffc2412b9cd933efa5936677.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/219263bad716496191697bed0e563d96.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/e293fb5fcf2c4fb6bdae910240b45551.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/c127301712514592bab07c27a4acc485.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/3ad189d6f6b3442ba4c52c3c8773e399.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/a6d0ed1c3e984af799e070393e475625.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/2b49b848918e453e9e2898bf258026ba.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/a3fa7b5281a940bebc1e9372b76eb7ae.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/1756744ef91f4831b839435742946dcb.png">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/08542b5eed9b49f49de3e29b9ea96b75.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/329a292725f549ebb2a60ba40fef97a9.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/06c2e52112934f719c5be77df6c390e9.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/f5c87dd03376406dbd5873bd0cd71012.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/f5c3c5d879a64ef0a2401ce39a4db73f.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/2fbc6748874c4ca69947896875a2bb57.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/1cf3a6fd9935422eb65dedd616d88411.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/8c4b464bf4c044cba9900d23eab05e67.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/40190eab138c42598e6ee722ba32e4f9.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/ad6ca36cdac847aba1b51aad800b58d8.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/7f0db330869542b8a33f6f8550e8feda.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/6086b015b42c4e20a73dbd8cf63f99cb.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/1d1e6302d46247248437ec34fc898ef0.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/1d0d5a8e4de24676a4a43f1a43d48eb5.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/8a39791ec7be44cb884955c80129a3d4.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/302f0aa66f6d4cf0b216a36ce170a15c.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/0e950708853346749a036d2765ced0a1.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/56d779105a2b4a9ca8620d31e7c2ce17.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/28c204cb923d4841929f22826d114227.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/e472a6edc0aa426cbac27fb3c7d4a1e0.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/86caed3868764fe293daa99356a4fbbe.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/b26f7cefa5fa4bf59ca604971c6faf3e.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/b5d707ffd21b4bd4a9d707de05617ed6.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/0f8211df5e0643099a0ba5016269969f.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/e025a70d9c9744ff9c19715d517e1389.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/6c83c3b2f988432d8b669c34f7e45b7d.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/ec2f5dfec4054833bff96702d837a124.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/99ac1ba0f68d484c9dcd7989d1b4debc.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/0c27d3091b514d6280c672608f6760d8.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/6fb5dd8eb1e8407fb75aa9c6ec740d98.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/5cdf6bd39bf842e7b3475cf08a531a34.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/042e1fe734da415a859d1dad1e0afe5c.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/30c2621fc84740d290fe27a327ab9b46.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/c8559bc8bf634a5a9d3cbb0898a46b88.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/00af6b4d6fc94d74b5244b5fdf04f914.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/3156e3a429a74feb9e07db605520d80d.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/f19f20f33b8045a280e66d068db3858d.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/23308b21cd724968bba51fe7e100c3a9.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/95fe9d07bd8a4da39bd2beb2b6da6fea.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/4ede1ec485a742a7bf35c70b0e36c626.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/8fbaab9f7ce441ab945cc019dd38d084.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/6188023b36644b088b5d46363d786005.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/c6d9461ae67a448681e19cb16ff19e80.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/fe51c527f7464b7e988db4a02940d2b8.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/c83c2db22d2e4a0493919fa7252caf73.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/619d76fb0d304246a02276af64e8ea25.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/728cfb1e692746b185b3ecb6ef10127b.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/7fe0552062814b36bbe6e97f005c1388.jpg">
<meta property="og:image" content="https://ucc.alicdn.com/pic/developer-ecology/d173857d6adc48d09954780f5b5cee18.jpg">
<meta property="article:published_time" content="2020-11-17T14:21:55.000Z">
<meta property="article:modified_time" content="2023-05-05T10:05:18.084Z">
<meta property="article:author" content="Jerry(姜源)">
<meta property="article:tag" content="问题排查">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20201117222659.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>01-线上问题快速排查思路 - 姜源の云笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"janycode.github.io","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":50,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"bfff735c897eb60ea49b735096b20e47","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>姜源の云笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tools/">
                <i class="iconfont icon-slack-fill"></i>
                工具
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://janycode.gitee.io/">
                <i class="iconfont icon-gitee-fill"></i>
                Gitee
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="01-线上问题快速排查思路"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Jerry(姜源)
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-11-17 22:21" pubdate>
          星期二, 2020/11/17 22:21:55
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          21k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          176 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">01-线上问题快速排查思路</h1>
            
            <div class="markdown-body">
              
              <p><img src="https://jy-imgs.oss-cn-beijing.aliyuncs.com/img/20201117222659.png" srcset="/img/loading.gif" lazyload alt="image-20201117222657771"></p>
<p>线上定位问题时，主要靠<code>监控</code>和<code>日志</code>。一旦超出监控的范围，则排查思路很重要，按照流程化的思路来定位问题，能够让我们在定位问题时从容、淡定，快速的定位到线上的问题。</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/046450040354435cb5fc34e1e885f4b8.jpg" srcset="/img/loading.gif" lazyload alt="2.jpg"></p>
<p>线上问题定位思维导图</p>
<h3 id="一-服务器层面"><a href="#一-服务器层面" class="headerlink" title="一 服务器层面"></a>一 服务器层面</h3><h4 id="1-1-磁盘"><a href="#1-1-磁盘" class="headerlink" title="1.1 磁盘"></a>1.1 磁盘</h4><h5 id="1-1-1-问题现象"><a href="#1-1-1-问题现象" class="headerlink" title="1.1.1 问题现象"></a>1.1.1 问题现象</h5><p>当磁盘容量不足的时候，应用时常会抛出如下的异常信息：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.IOException</span>: 磁盘空间不足<br></code></pre></td></tr></table></figure>

<p>或是类似如下告警信息：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/368a1ed9ffc84883a43f668f70e43c0e.jpg" srcset="/img/loading.gif" lazyload alt="3.jpg"></p>
<h5 id="1-1-2-排查思路"><a href="#1-1-2-排查思路" class="headerlink" title="1.1.2 排查思路"></a>1.1.2 排查思路</h5><h5 id="1-1-2-1-利用-df-查询磁盘状态"><a href="#1-1-2-1-利用-df-查询磁盘状态" class="headerlink" title="1.1.2.1 利用 df 查询磁盘状态"></a>1.1.2.1 利用 df 查询磁盘状态</h5><p>利用以下指令获取磁盘状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">df</span> -h<br></code></pre></td></tr></table></figure>

<p>结果是：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/a3ffed5571434523a1fdf88b3d6929c9.jpg" srcset="/img/loading.gif" lazyload alt="4.jpg"></p>
<p>可知 &#x2F; 路径下占用量最大。</p>
<h6 id="1-1-2-2-利用-du-查看文件夹大小"><a href="#1-1-2-2-利用-du-查看文件夹大小" class="headerlink" title="1.1.2.2 利用 du 查看文件夹大小"></a>1.1.2.2 利用 du 查看文件夹大小</h6><p>利用以下指令获取目录下文件夹大小：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">du</span> -sh *<br></code></pre></td></tr></table></figure>

<p>结果是：</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/30bd3f18a45346cdb9a16d093ebee9f4.jpg" srcset="/img/loading.gif" lazyload alt="5.jpg"></p>
<p>可知root文件夹占用空间最大，然后层层递推找到对应的最大的一个或数个文件夹。</p>
<h6 id="1-1-2-3-利用-ls-查看文件大小"><a href="#1-1-2-3-利用-ls-查看文件大小" class="headerlink" title="1.1.2.3 利用 ls 查看文件大小"></a>1.1.2.3 利用 ls 查看文件大小</h6><p>利用以下指令获取目录下文件夹大小：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ls</span> -<span class="hljs-keyword">lh</span><br></code></pre></td></tr></table></figure>

<p>结果是：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/8609b9a4431b4f0ab8b5ffa5d275b25c.jpg" srcset="/img/loading.gif" lazyload alt="6.jpg"></p>
<p>可以找到最大的文件是日志文件，然后使用rm指令进行移除以释放磁盘。</p>
<h5 id="1-1-3-相关命令"><a href="#1-1-3-相关命令" class="headerlink" title="1.1.3 相关命令"></a>1.1.3 相关命令</h5><h6 id="1-1-3-1-df"><a href="#1-1-3-1-df" class="headerlink" title="1.1.3.1 df"></a>1.1.3.1 df</h6><p>主要是用于显示目前在 Linux 系统上的文件系统磁盘使用情况统计。</p>
<p>（1）常用参数</p>
<p>启动参数：</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/31b80090624248009a926ae490ee8129.jpg" srcset="/img/loading.gif" lazyload alt="7.jpg"><br>（2）结果参数<br><img src="https://ucc.alicdn.com/pic/developer-ecology/cc3a8d71acb14eb58fc6d10bb505811a.jpg" srcset="/img/loading.gif" lazyload alt="8.jpg"><br><img src="https://ucc.alicdn.com/pic/developer-ecology/e732d7cb94984eadb99043f934338c7f.jpg" srcset="/img/loading.gif" lazyload alt="9.jpg"><br>1.1.3.2 du</p>
<p>主要是为了显示目录或文件的大小。</p>
<p>（1）常用参数</p>
<p>启动参数：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/48fa0478bef54d9f9a85a6e4bad340ab.jpg" srcset="/img/loading.gif" lazyload alt="10.jpg"><br>（2）结果参数</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/214e3676a08244e6bea119bd3a1cf821.jpg" srcset="/img/loading.gif" lazyload alt="1d23413adb892d602c344099bf3fb13.jpg"></p>
<p>1.1.3.3 ls</p>
<p>主要是用于显示指定工作目录下的内容的信息。</p>
<p>（1）常用参数</p>
<p>启动参数：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/5c1439d594c7455cb29cdb112464fff4.jpg" srcset="/img/loading.gif" lazyload alt="11.jpg"><br>（2）结果参数</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/82d681f48f7e4bf4b3fcd60b3d4de2e5.jpg" srcset="/img/loading.gif" lazyload alt="12.jpg"></p>
<h4 id="1-2-CPU过高"><a href="#1-2-CPU过高" class="headerlink" title="1.2 CPU过高"></a>1.2 CPU过高</h4><h5 id="1-2-1-问题现象"><a href="#1-2-1-问题现象" class="headerlink" title="1.2.1 问题现象"></a>1.2.1 问题现象</h5><p>当CPU过高的时候，接口性能会快速下降，同时监控也会开始报警。</p>
<h5 id="1-2-2-排查思路"><a href="#1-2-2-排查思路" class="headerlink" title="1.2.2 排查思路"></a>1.2.2 排查思路</h5><h6 id="1-2-2-1-利用-top-查询CPU使用率最高的进程"><a href="#1-2-2-1-利用-top-查询CPU使用率最高的进程" class="headerlink" title="1.2.2.1 利用 top 查询CPU使用率最高的进程"></a>1.2.2.1 利用 top 查询CPU使用率最高的进程</h6><p>利用以下指令获取系统CPU使用率信息：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">top</span><br></code></pre></td></tr></table></figure>

<p>结果是：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/8568dab2768d41b38dc4e08f57e5f6e6.jpg" srcset="/img/loading.gif" lazyload alt="13.jpg"><br>从而可以得知pid为14201的进程使用CPU最高。</p>
<h5 id="1-2-3-相关命令"><a href="#1-2-3-相关命令" class="headerlink" title="1.2.3 相关命令"></a>1.2.3 相关命令</h5><h6 id="1-2-3-1-top"><a href="#1-2-3-1-top" class="headerlink" title="1.2.3.1 top"></a>1.2.3.1 top</h6><p>（1）常用参数</p>
<p>启动参数：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/5dd23103e55d49a3b92ef5319294e71b.jpg" srcset="/img/loading.gif" lazyload alt="14.jpg"><br>top进程内指令参数：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/41ca38d4ffc2412b9cd933efa5936677.jpg" srcset="/img/loading.gif" lazyload alt="15.jpg"><br>（2）结果参数<br><img src="https://ucc.alicdn.com/pic/developer-ecology/219263bad716496191697bed0e563d96.jpg" srcset="/img/loading.gif" lazyload alt="16.jpg"><br><img src="https://ucc.alicdn.com/pic/developer-ecology/e293fb5fcf2c4fb6bdae910240b45551.jpg" srcset="/img/loading.gif" lazyload alt="17.jpg"></p>
<h3 id="二-应用层面"><a href="#二-应用层面" class="headerlink" title="二 应用层面"></a>二 应用层面</h3><h4 id="2-1-Tomcat假死案例分析"><a href="#2-1-Tomcat假死案例分析" class="headerlink" title="2.1 Tomcat假死案例分析"></a>2.1 Tomcat假死案例分析</h4><h5 id="2-1-1-发现问题"><a href="#2-1-1-发现问题" class="headerlink" title="2.1.1 发现问题"></a>2.1.1 发现问题</h5><p>监控平台发现某个Tomcat节点已经无法采集到数据，连上服务器查看服务器进程还在，netstat -anop|grep 8001端口也有监听，查看日志打印时断时续。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/c127301712514592bab07c27a4acc485.jpg" srcset="/img/loading.gif" lazyload alt="18.jpg"></p>
<h5 id="2-2-2-查询日志"><a href="#2-2-2-查询日志" class="headerlink" title="2.2.2 查询日志"></a>2.2.2 查询日志</h5><p>查看NG日志，发现有数据进入到当前服务器（有8001和8002两个Tomcat），NG显示8002节点访问正常，8001节点有404错误打印，说明Tomcat已经处于假死状态，这个Tomcat已经不能正常工作了。</p>
<p>过滤Tomcat节点的日志，发现有OOM的异常,但是重启后，有时候Tomcat挂掉后，又不会打印如下OOM的异常：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">TopicNewController.getTopicSoftList() <span class="hljs-attribute">error</span>=<span class="hljs-string">&quot;Java heap space </span><br><span class="hljs-string">From class java.lang.OutOfMemoryError&quot;</span>appstore_apitomcat<br></code></pre></td></tr></table></figure>

<h5 id="2-2-3-获取内存快照"><a href="#2-2-3-获取内存快照" class="headerlink" title="2.2.3 获取内存快照"></a>2.2.3 获取内存快照</h5><p>在一次OOM发生后立刻抓取内存快照,需要执行命令的用户与JAVA进程启动用户是同一个，否则会有异常：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-regexp">/data/</span>program<span class="hljs-regexp">/jdk/</span>bin<span class="hljs-regexp">/jmap -dump:live,format=b,file=/</span>home<span class="hljs-regexp">/www/</span>jmaplogs/jmap-<span class="hljs-number">8001</span>-<span class="hljs-number">2</span>.bin <span class="hljs-number">18760</span><br><br>ps -ef|<span class="hljs-keyword">grep</span> store.cn.xml|<span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span>|awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>|xargs <span class="hljs-regexp">/data/</span>program<span class="hljs-regexp">/jdk-1.8.0_11/</span>bin/jmap -<span class="hljs-keyword">dump</span>:live,format=b,<span class="hljs-keyword">file</span>=api.bin<br></code></pre></td></tr></table></figure>

<p>内存dump文件比较大，有1.4G，先压缩，然后拉取到本地用7ZIP解压。</p>
<p>linux压缩dump为.tgz。</p>
<p>在windows下用7zip需要经过2步解压：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.bin</span><span class="hljs-selector-class">.tgz---</span><span class="hljs-selector-class">.bin</span><span class="hljs-selector-class">.tar--</span>.bin<br></code></pre></td></tr></table></figure>

<h5 id="2-2-4-分析内存快照文件"><a href="#2-2-4-分析内存快照文件" class="headerlink" title="2.2.4 分析内存快照文件"></a>2.2.4 分析内存快照文件</h5><p>使用Memory Analyzer解析dump文件，发现有很明显的内存泄漏提示。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/3ad189d6f6b3442ba4c52c3c8773e399.jpg" srcset="/img/loading.gif" lazyload alt="19.jpg"><br>点击查看详情，发现定位到了代码的具体某行，一目了然：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/a6d0ed1c3e984af799e070393e475625.jpg" srcset="/img/loading.gif" lazyload alt="20.jpg"><br>查看shallow heap与retained heap能发现生成了大量的Object(810325个对象)，后面分析代码发现是上报softItem对象超过300多万个对象，在循环的时候，所有的数据全部保存在某个方法中无法释放，导致内存堆积到1.5G，从而超过了JVM分配的最大数，从而出现OOM。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/2b49b848918e453e9e2898bf258026ba.jpg" srcset="/img/loading.gif" lazyload alt="21.jpg"></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Object</span><span class="hljs-selector-attr">[810325]</span> @ <span class="hljs-number">0</span>xb0e971e0<br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/a3fa7b5281a940bebc1e9372b76eb7ae.jpg" srcset="/img/loading.gif" lazyload alt="22.jpg"></p>
<h5 id="2-2-5-相关知识"><a href="#2-2-5-相关知识" class="headerlink" title="2.2.5 相关知识"></a>2.2.5 相关知识</h5><h6 id="2-2-5-1-JVM内存"><a href="#2-2-5-1-JVM内存" class="headerlink" title="2.2.5.1 JVM内存"></a>2.2.5.1 JVM内存</h6><p><img src="https://ucc.alicdn.com/pic/developer-ecology/1756744ef91f4831b839435742946dcb.png" srcset="/img/loading.gif" lazyload alt="1111.png"><br>2.2.5.2 内存分配的流程<br><img src="https://ucc.alicdn.com/pic/developer-ecology/08542b5eed9b49f49de3e29b9ea96b75.jpg" srcset="/img/loading.gif" lazyload alt="24.jpg"><br>如果通过逃逸分析，则会先在TLAB分配，如果不满足条件才在Eden上分配。</p>
<h6 id="2-2-4-3-GC"><a href="#2-2-4-3-GC" class="headerlink" title="2.2.4.3 GC"></a>2.2.4.3 GC</h6><p><img src="https://ucc.alicdn.com/pic/developer-ecology/329a292725f549ebb2a60ba40fef97a9.jpg" srcset="/img/loading.gif" lazyload alt="25.jpg"><br>（1）GC触发的场景<br><img src="https://ucc.alicdn.com/pic/developer-ecology/06c2e52112934f719c5be77df6c390e9.jpg" srcset="/img/loading.gif" lazyload alt="26.jpg"><br>2）GC Roots</p>
<p>GC Roots有4种对象：</p>
<ul>
<li><p>虚拟机栈(栈桢中的本地变量表)中的引用的对象，就是平时所指的java对象，存放在堆中。</p>
</li>
<li><p>方法区中的类静态属性引用的对象，一般指被static修饰引用的对象，加载类的时候就加载到内存中。</p>
</li>
<li><p>方法区中的常量引用的对象。</p>
</li>
<li><p>本地方法栈中JNI（native方法)引用的对象。</p>
</li>
</ul>
<p>（3）GC算法</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/f5c87dd03376406dbd5873bd0cd71012.jpg" srcset="/img/loading.gif" lazyload alt="27.jpg"></p>
<ul>
<li><p>串行只使用单条GC线程进行处理，而并行则使用多条。</p>
</li>
<li><p>多核情况下，并行一般更有执行效率，但是单核情况下，并行未必比串行更有效率。</p>
</li>
</ul>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/f5c3c5d879a64ef0a2401ce39a4db73f.jpg" srcset="/img/loading.gif" lazyload alt="28.jpg"></p>
<ul>
<li><p>STW会暂停所有应用线程的执行，等待GC线程完成后再继续执行应用线程，从而会导致短时间内应用无响应。</p>
</li>
<li><p>Concurrent会导致GC线程和应用线程并发执行，因此应用线程和GC线程互相抢用CPU，从而会导致出现浮动垃圾，同时GC时间不可控。</p>
</li>
</ul>
<p>（4）新生代使用的GC算法<br><img src="https://ucc.alicdn.com/pic/developer-ecology/2fbc6748874c4ca69947896875a2bb57.jpg" srcset="/img/loading.gif" lazyload alt="29.jpg"></p>
<ul>
<li><p>新生代算法都是基于Coping的，速度快。</p>
</li>
<li><p>Parallel Scavenge：吞吐量优先。</p>
</li>
<li><ul>
<li>吞吐量&#x3D;运行用户代码时间 &#x2F;（运行用户代码时间 + 垃圾收集时间）</li>
</ul>
</li>
</ul>
<p>（5）老年代使用的GC算法<br><img src="https://ucc.alicdn.com/pic/developer-ecology/1cf3a6fd9935422eb65dedd616d88411.jpg" srcset="/img/loading.gif" lazyload alt="30.jpg"><br><img src="https://ucc.alicdn.com/pic/developer-ecology/8c4b464bf4c044cba9900d23eab05e67.jpg" srcset="/img/loading.gif" lazyload alt="31.jpg"></p>
<p>Parallel Compacting</p>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/40190eab138c42598e6ee722ba32e4f9.jpg" srcset="/img/loading.gif" lazyload alt="32.jpg"></p>
<p>Concurrent Mark-Sweep(CMS)</p>
<p>（6）垃圾收集器总结<br><img src="https://ucc.alicdn.com/pic/developer-ecology/ad6ca36cdac847aba1b51aad800b58d8.jpg" srcset="/img/loading.gif" lazyload alt="33.jpg"><br>（7）实际场景中算法使用的组合<br><img src="https://ucc.alicdn.com/pic/developer-ecology/7f0db330869542b8a33f6f8550e8feda.jpg" srcset="/img/loading.gif" lazyload alt="34.jpg"><br>（8）GC日志格式</p>
<p>（a）监控内存的OOM场景</p>
<p>不要在线上使用jmap手动抓取内存快照，其一系统OOM时手工触发已经来不及，另外在生成dump文件时会占用系统内存资源，导致系统崩溃。只需要在JVM启动参数中提取设置如下参数，一旦OOM触发会自动生成对应的文件，用MAT分析即可。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 内存OOM时，自动生成dump文件 </span><br>-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/data/logs/</span><br></code></pre></td></tr></table></figure>

<p>如果Young GC比较频繁，5S内有打印一条，或者有Old GC的打印，代表内存设置过小或者有内存泄漏，此时需要抓取内存快照进行分享。</p>
<p>（b）Young Gc日志</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2020</span>-<span class="hljs-number">09</span>-<span class="hljs-number">23</span>T01:<span class="hljs-number">45</span>:<span class="hljs-number">05</span>.<span class="hljs-number">487</span>+<span class="hljs-number">0800</span>: <span class="hljs-number">126221</span>.<span class="hljs-number">918</span>:<span class="hljs-meta"> [GC (Allocation Failure) 2020-09-23T01:45:05.487+0800: 126221.918: [ParNew: 1750755K-&gt;2896K(1922432K), 0.0409026 secs] 1867906K-&gt;120367K(4019584K), 0.0412358 secs] [Times: user=0.13 sys=0.01, real=0.04 secs]</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/6086b015b42c4e20a73dbd8cf63f99cb.jpg" srcset="/img/loading.gif" lazyload alt="35.jpg"><br>（c）Old GC日志</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2020</span><span class="hljs-operator">-</span><span class="hljs-number">10</span><span class="hljs-operator">-</span><span class="hljs-number">27</span><span class="hljs-variable">T20</span><span class="hljs-operator">:</span><span class="hljs-number">27</span><span class="hljs-operator">:</span><span class="hljs-number">57.733</span><span class="hljs-operator">+</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">639877.297</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Heap</span> <span class="hljs-variable">Inspection</span> <span class="hljs-variable">Initiated</span> <span class="hljs-variable">GC</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2020</span><span class="hljs-operator">-</span><span class="hljs-number">10</span><span class="hljs-operator">-</span><span class="hljs-number">27</span><span class="hljs-variable">T20</span><span class="hljs-operator">:</span><span class="hljs-number">27</span><span class="hljs-operator">:</span><span class="hljs-number">57.733</span><span class="hljs-operator">+</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">639877.297</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">CMS</span><span class="hljs-operator">:</span> <span class="hljs-number">165992</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">120406</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">524288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.7776748</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">329034</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">120406</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1004928</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">178787</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">178787</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1216512</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.7787158</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.71</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.78</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/1d1e6302d46247248437ec34fc898ef0.jpg" srcset="/img/loading.gif" lazyload alt="36.jpg"></p>
<h4 id="2-2-应用CPU过高"><a href="#2-2-应用CPU过高" class="headerlink" title="2.2 应用CPU过高"></a>2.2 应用CPU过高</h4><h5 id="2-2-1-发现问题"><a href="#2-2-1-发现问题" class="headerlink" title="2.2.1 发现问题"></a>2.2.1 发现问题</h5><p>一般情况下会有监控告警进行提示：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/1d0d5a8e4de24676a4a43f1a43d48eb5.jpg" srcset="/img/loading.gif" lazyload alt="37.jpg"></p>
<h5 id="2-2-2-查找问题进程"><a href="#2-2-2-查找问题进程" class="headerlink" title="2.2.2 查找问题进程"></a>2.2.2 查找问题进程</h5><p>利用top查到占用cpu最高的进程pid为14，结果图如下：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/8a39791ec7be44cb884955c80129a3d4.jpg" srcset="/img/loading.gif" lazyload alt="38.jpg"></p>
<h5 id="2-2-3-查找问题线程"><a href="#2-2-3-查找问题线程" class="headerlink" title="2.2.3 查找问题线程"></a>2.2.3 查找问题线程</h5><p>利用 top -H -p 查看进程内占用cpu最高线程，从下图可知，问题线程主要是activeCpu Thread，其pid为417。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/302f0aa66f6d4cf0b216a36ce170a15c.jpg" srcset="/img/loading.gif" lazyload alt="39.jpg"></p>
<h5 id="2-2-4-查询线程详细信息"><a href="#2-2-4-查询线程详细信息" class="headerlink" title="2.2.4 查询线程详细信息"></a>2.2.4 查询线程详细信息</h5><ul>
<li><p>首先利用 printf “%x n” 将tid换为十六进制：xid。</p>
</li>
<li><p>再利用 jstack | grep nid&#x3D;0x -A 10 查询线程信息(若进程无响应，则使用 jstack -f )，信息如下：</p>
</li>
</ul>
<p><img src="https://ucc.alicdn.com/pic/developer-ecology/0e950708853346749a036d2765ced0a1.jpg" srcset="/img/loading.gif" lazyload alt="40.jpg"></p>
<h5 id="2-2-5-分析代码"><a href="#2-2-5-分析代码" class="headerlink" title="2.2.5 分析代码"></a>2.2.5 分析代码</h5><p>由上一步可知该问题是由 CpuThread.java 类引发的，故查询项目代码，获得如下信息：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/56d779105a2b4a9ca8620d31e7c2ce17.jpg" srcset="/img/loading.gif" lazyload alt="41.jpg"></p>
<h5 id="2-2-6-获得结论"><a href="#2-2-6-获得结论" class="headerlink" title="2.2.6 获得结论"></a>2.2.6 获得结论</h5><p>根据代码和日志分析，可知是由于限制值max太大，致使线程长时间循环执行，从而导致问题出现。</p>
<h3 id="三-Mysql"><a href="#三-Mysql" class="headerlink" title="三 Mysql"></a>三 Mysql</h3><h4 id="3-1-死锁"><a href="#3-1-死锁" class="headerlink" title="3.1 死锁"></a>3.1 死锁</h4><h5 id="3-1-1-问题出现"><a href="#3-1-1-问题出现" class="headerlink" title="3.1.1 问题出现"></a>3.1.1 问题出现</h5><p>最近线上随着流量变大，突然开始报如下异常，即发生了死锁问题：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Deadlock <span class="hljs-built_in">found</span> <span class="hljs-keyword">when</span> trying <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> <span class="hljs-keyword">lock</span>; try restarting <span class="hljs-keyword">transaction</span> ;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-2-问题分析"><a href="#3-1-2-问题分析" class="headerlink" title="3.1.2 问题分析"></a>3.1.2 问题分析</h5><h6 id="3-1-2-1-查询事务隔离级别"><a href="#3-1-2-1-查询事务隔离级别" class="headerlink" title="3.1.2.1 查询事务隔离级别"></a>3.1.2.1 查询事务隔离级别</h6><p>利用 select @@tx_isolation 命令获取到数据库隔离级别信息：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/28c204cb923d4841929f22826d114227.jpg" srcset="/img/loading.gif" lazyload alt="42.jpg"></p>
<h5 id="3-1-2-2-查询数据库死锁日志"><a href="#3-1-2-2-查询数据库死锁日志" class="headerlink" title="3.1.2.2 查询数据库死锁日志"></a>3.1.2.2 查询数据库死锁日志</h5><p>利用 show engine innodb status 命令获取到如下死锁信息：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/e472a6edc0aa426cbac27fb3c7d4a1e0.jpg" srcset="/img/loading.gif" lazyload alt="43.jpg"><br><img src="https://ucc.alicdn.com/pic/developer-ecology/86caed3868764fe293daa99356a4fbbe.jpg" srcset="/img/loading.gif" lazyload alt="44.jpg"><br>由上可知，是由于两个事物对这条记录同时持有S锁(共享锁)的情况下，再次尝试获取该条记录的X锁(排它锁)，从而导致互相等待引发死锁。</p>
<h5 id="3-1-2-3-分析代码"><a href="#3-1-2-3-分析代码" class="headerlink" title="3.1.2.3 分析代码"></a>3.1.2.3 分析代码</h5><p>根据死锁日志的SQL语句，定位获取到如下伪代码逻辑：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@<span class="hljs-constructor">Transactional(<span class="hljs-params">rollbackFor</span> = Exception.<span class="hljs-params">class</span>)</span><br>void save<span class="hljs-constructor">OrUpdate(MeetingInfo <span class="hljs-params">info</span>)</span> &#123;<br>    <span class="hljs-comment">// insert ignore into table values (...)</span><br>    <span class="hljs-built_in">int</span> result = mapper.insert<span class="hljs-constructor">Ignore(<span class="hljs-params">info</span>)</span>;<br>    <span class="hljs-keyword">if</span> (result&gt;<span class="hljs-number">0</span>) &#123;<br>       return;<br>    &#125;<br>    <span class="hljs-comment">// update table set xx=xx where id = xx</span><br>    mapper.update(info);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-2-4-获得结论"><a href="#3-1-2-4-获得结论" class="headerlink" title="3.1.2.4 获得结论"></a>3.1.2.4 获得结论</h5><p>分析获得产生问题的加锁时序如下，然后修改代码实现以解决该问题。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/b26f7cefa5fa4bf59ca604971c6faf3e.jpg" srcset="/img/loading.gif" lazyload alt="45.jpg"></p>
<h4 id="3-2-慢SQL"><a href="#3-2-慢SQL" class="headerlink" title="3.2 慢SQL"></a>3.2 慢SQL</h4><h5 id="3-2-1-问题出现"><a href="#3-2-1-问题出现" class="headerlink" title="3.2.1 问题出现"></a>3.2.1 问题出现</h5><p>应用TPS下降，并出现SQL执行超时异常或者出现了类似如下的告警信息，则常常意味着出现了慢SQL。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/b5d707ffd21b4bd4a9d707de05617ed6.jpg" srcset="/img/loading.gif" lazyload alt="46.jpg"></p>
<h4 id="3-2-2-问题分析"><a href="#3-2-2-问题分析" class="headerlink" title="3.2.2 问题分析"></a>3.2.2 问题分析</h4><p>分析执行计划：利用explain指令获得该SQL语句的执行计划，根据该执行计划，可能有两种场景。</p>
<p>SQL不走索引或扫描行数过多等致使执行时长过长。</p>
<p>SQL没问题，只是因为事务并发导致等待锁，致使执行时长过长。</p>
<h5 id="3-2-3-场景一"><a href="#3-2-3-场景一" class="headerlink" title="3.2.3 场景一"></a>3.2.3 场景一</h5><h6 id="3-2-3-1-优化SQL"><a href="#3-2-3-1-优化SQL" class="headerlink" title="3.2.3.1 优化SQL"></a>3.2.3.1 优化SQL</h6><p>通过增加索引，调整SQL语句的方式优化执行时长， 例如下的执行计划：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/0f8211df5e0643099a0ba5016269969f.jpg" srcset="/img/loading.gif" lazyload alt="47.jpg"></p>
<p>该SQL的执行计划的type为ALL，同时根据以下type语义，可知无索引的全表查询，故可为其检索列增加索引进而解决。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/e025a70d9c9744ff9c19715d517e1389.jpg" srcset="/img/loading.gif" lazyload alt="48.jpg"></p>
<h5 id="3-2-4-场景二"><a href="#3-2-4-场景二" class="headerlink" title="3.2.4 场景二"></a>3.2.4 场景二</h5><h6 id="3-2-4-1-查询当前事务情况"><a href="#3-2-4-1-查询当前事务情况" class="headerlink" title="3.2.4.1 查询当前事务情况"></a>3.2.4.1 查询当前事务情况</h6><p>可以通过查看如下3张表做相应的处理：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 当前运行的所有事务</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>  <span class="hljs-keyword">from</span> information_schema.innodb_trx;<br><span class="hljs-comment">-- 当前出现的锁</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCKS;<br><span class="hljs-comment">-- 锁等待的对应关系</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span>  <span class="hljs-keyword">from</span> information_schema.INNODB_LOCK_WAITS;<br></code></pre></td></tr></table></figure>

<p>（1）查看当前的事务有哪些：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/6c83c3b2f988432d8b669c34f7e45b7d.jpg" srcset="/img/loading.gif" lazyload alt="49.jpg"><br>（2）查看事务锁类型索引的详细信息：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/ec2f5dfec4054833bff96702d837a124.jpg" srcset="/img/loading.gif" lazyload alt="50.jpg"><br>lock_table字段能看到被锁的索引的表名，lock_mode可以看到锁类型是X锁,lock_type可以看到是行锁record。</p>
<h5 id="3-2-4-2-分析"><a href="#3-2-4-2-分析" class="headerlink" title="3.2.4.2 分析"></a>3.2.4.2 分析</h5><p>根据事务情况，得到表信息，和相关的事务时序信息：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">DROP</span> TABLE <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-symbol">`emp`</span>;<br><span class="hljs-keyword">CREATE</span> TABLE <span class="hljs-symbol">`emp`</span> (<br><span class="hljs-symbol">`id`</span> int(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br><span class="hljs-symbol">`salary`</span> int(<span class="hljs-number">10</span>) DEFAULT <span class="hljs-literal">NULL</span>,<br><span class="hljs-symbol">`name`</span> varchar(<span class="hljs-number">255</span>) DEFAULT <span class="hljs-literal">NULL</span>,<br><span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> (<span class="hljs-symbol">`id`</span>),<br><span class="hljs-keyword">KEY</span> <span class="hljs-symbol">`idx_name`</span> (<span class="hljs-symbol">`name`</span>(<span class="hljs-number">191</span>)) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE=InnoDB AUTO_INCREMENT=<span class="hljs-number">6</span> DEFAULT CHARSET=utf8mb4;<br></code></pre></td></tr></table></figure>

<p>A事物锁住一条记录，不提交，B事物需要更新此条记录，此时会阻塞，如下图是执行顺序：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/99ac1ba0f68d484c9dcd7989d1b4debc.jpg" srcset="/img/loading.gif" lazyload alt="51.jpg"></p>
<h5 id="3-2-4-3-解决方案"><a href="#3-2-4-3-解决方案" class="headerlink" title="3.2.4.3 解决方案"></a>3.2.4.3 解决方案</h5><p>（1）修改方案</p>
<p>由前一步的结果,分析事务间加锁时序，例如可以通过tx_query字段得知被阻塞的事务SQL,trx_state得知事务状态等，找到对应代码逻辑，进行优化修改。</p>
<p>（2）临时修改方案</p>
<p>trx_mysql_thread_id是对应的事务sessionId，可以通过以下命令杀死长时间执行的事务，从而避免阻塞其他事务执行。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kill</span> <span class="hljs-number">105853</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-连接数过多"><a href="#3-3-连接数过多" class="headerlink" title="3.3 连接数过多"></a>3.3 连接数过多</h3><h4 id="3-3-1-问题出现"><a href="#3-3-1-问题出现" class="headerlink" title="3.3.1 问题出现"></a>3.3.1 问题出现</h4><p>常出现too many connections异常,数据库连接到达最大连接数。</p>
<h5 id="3-3-2-解决方案"><a href="#3-3-2-解决方案" class="headerlink" title="3.3.2 解决方案"></a>3.3.2 解决方案</h5><p>解决方案：</p>
<p>通过set global max_connections&#x3D;XXX增大最大连接数。</p>
<p>先利用show processlist获取连接信息，然后利用kill杀死过多的连。</p>
<p>常用脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">排序数据库连接的数目 <br>mysql -h127.0.0.0.1 -uabc_test -pXXXXX -P3306 -A -e <span class="hljs-string">&#x27;show processlist&#x27;</span>| awk <span class="hljs-string">&#x27;&#123;print $4&#125;&#x27;</span>|<span class="hljs-built_in">sort</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -rn|<span class="hljs-built_in">head</span> -10<br></code></pre></td></tr></table></figure>

<h4 id="3-4-相关知识"><a href="#3-4-相关知识" class="headerlink" title="3.4 相关知识"></a>3.4 相关知识</h4><h5 id="3-4-1-索引"><a href="#3-4-1-索引" class="headerlink" title="3.4.1 索引"></a>3.4.1 索引</h5><p>3.4.1.1 MySql不同的存储引擎<br><img src="https://ucc.alicdn.com/pic/developer-ecology/0c27d3091b514d6280c672608f6760d8.jpg" srcset="/img/loading.gif" lazyload alt="52.jpg"></p>
<h6 id="3-4-1-2-InnoDB-B-Tree索引实现"><a href="#3-4-1-2-InnoDB-B-Tree索引实现" class="headerlink" title="3.4.1.2 InnoDB B+Tree索引实现"></a>3.4.1.2 InnoDB B+Tree索引实现</h6><p>主键索引(聚集索引)：</p>
<ul>
<li><p>叶子节点data域保存了完整的数据的地址。</p>
</li>
<li><p>主键与数据全部存储在一颗树上。</p>
</li>
<li><p>Root节点常驻内存。</p>
</li>
<li><p>每个非叶子节点一个innodb_page_size大小,加速磁盘IO。</p>
</li>
<li><p>磁盘的I&#x2F;O要比内存慢几百倍，而磁盘慢的原因在于机械设备寻找磁道慢，因此采用磁盘预读，每次读取一个磁盘页（page:计算机管理存储器的逻辑块-通常为4k）的整倍数。</p>
</li>
<li><p>如果没有主键,MySQL默认生成隐含字段作为主键，这个字段长度为6个字节，类型为长整形。</p>
</li>
<li><p>辅助索引结构与主索引相同,但叶子节点data域保存的是主键指针。</p>
</li>
<li><p>InnoDB以表空间Tablespace(idb文件)结构进行组织，每个Tablespace 包含多个Segment段。</p>
</li>
<li><p>每个段(分为2种段：叶子节点Segment&amp;非叶子节点Segment)，一个Segment段包含多个Extent。</p>
</li>
<li><p>一个Extent占用1M空间包含64个Page（每个Page 16k），InnoDB B-Tree 一个逻辑节点就分配一个物理Page，一个节点一次IO操作。</p>
</li>
<li><p>一个Page里包含很多有序数据Row行数据，Row行数据中包含Filed属性数据等信息。</p>
</li>
</ul>
<p>InnoDB存储引擎中页的大小为16KB，一般表的主键类型为INT（占用4个字节）或BIGINT（占用8个字节），指针类型也一般为4或8个字节，也就是说一个页（B+Tree中的一个节点）中大概存储16KB&#x2F;(8B+8B)&#x3D;1K个键值（因为是估值，为方便计算，这里的K取值为[10]^3）。</p>
<p>也就是说一个深度为3的B+Tree索引可以维护 10^3 <em>10^3</em> 10^3 &#x3D; 10亿 条记录。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/6fb5dd8eb1e8407fb75aa9c6ec740d98.jpg" srcset="/img/loading.gif" lazyload alt="53.jpg"><br>每个索引的左指针都是比自己小的索引&#x2F;节点，右指针是大于等于自己的索引&#x2F;节点。</p>
<h5 id="3-4-2-B-Tree索引检索"><a href="#3-4-2-B-Tree索引检索" class="headerlink" title="3.4.2 B+ Tree索引检索"></a>3.4.2 B+ Tree索引检索</h5><h6 id="3-4-2-1-主键索引检索"><a href="#3-4-2-1-主键索引检索" class="headerlink" title="3.4.2.1 主键索引检索"></a>3.4.2.1 主键索引检索</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/5cdf6bd39bf842e7b3475cf08a531a34.jpg" srcset="/img/loading.gif" lazyload alt="54.jpg"></p>
<h6 id="3-4-2-2-辅助索引检索"><a href="#3-4-2-2-辅助索引检索" class="headerlink" title="3.4.2.2 辅助索引检索"></a>3.4.2.2 辅助索引检索</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> = <span class="hljs-string">&#x27;a&#x27;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/042e1fe734da415a859d1dad1e0afe5c.jpg" srcset="/img/loading.gif" lazyload alt="55.jpg"></p>
<h5 id="3-4-3-事物的隔离级别"><a href="#3-4-3-事物的隔离级别" class="headerlink" title="3.4.3 事物的隔离级别"></a>3.4.3 事物的隔离级别</h5><h6 id="3-4-3-1-如何查看数据库的事务隔离级别"><a href="#3-4-3-1-如何查看数据库的事务隔离级别" class="headerlink" title="3.4.3.1 如何查看数据库的事务隔离级别"></a>3.4.3.1 如何查看数据库的事务隔离级别</h6><p>使用如下命令可以查看事务的隔离级别：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams">show <span class="hljs-keyword">variables</span> like <span class="hljs-comment">&#x27;tx_isolation&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>阿里云上的rds的隔离级别是read committed ，而不是原生mysql的“可重复读（repeatable-read）。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/30c2621fc84740d290fe27a327ab9b46.jpg" srcset="/img/loading.gif" lazyload alt="56.jpg"></p>
<ul>
<li><p>Repeatable read不存在幻读的问题，RR隔离级别保证对读取到的记录加锁 (记录锁)，同时保证对读取的范围加锁，新的满足查询条件的记录不能够插入 (间隙锁)，不存在幻读现象。</p>
</li>
<li><p>在MYSQL的事务引擎中，INNODB是使用范围最广的。它默认的事务隔离级别是REPEATABLE READ(可重复读），在标准的事务隔离级别定义下，REPEATABLE READ是不能防止幻读产生的。INNODB使用了next-key locks实现了防止幻读的发生。</p>
</li>
<li><p>在默认情况下，mysql的事务隔离级别是可重复读，并且innodb_locks_unsafe_for_binlog参数为OFF，这时默认采用next-key locks。所谓Next-Key Locks，就是Record lock和gap lock的结合，即除了锁住记录本身，还要再锁住索引之间的间隙。可以设置为ON，则RR隔离级别时会出现幻读。</p>
</li>
</ul>
<h6 id="3-4-3-2-多版本并发控制MVCC"><a href="#3-4-3-2-多版本并发控制MVCC" class="headerlink" title="3.4.3.2 多版本并发控制MVCC"></a>3.4.3.2 多版本并发控制MVCC</h6><p>MySQL InnoDB存储引擎，实现的是基于多版本的并发控制协议——MVCC (Multi-Version Concurrency Control) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)。</p>
<p>MVCC最大的好处，相信也是耳熟能详：读不加锁，读写不冲突。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。</p>
<p>在MVCC并发控制中，读操作可以分成两类：快照读 (snapshot read)与当前读 (current read)。</p>
<p>快照读：简单的select操作，属于快照读，不加锁。(当然，也有例外，下面会分析)。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> ?;<br></code></pre></td></tr></table></figure>

<p>当前读：特殊的读操作，插入&#x2F;更新&#x2F;删除操作，属于当前读，需要加锁。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> ? <span class="hljs-keyword">lock</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">share mode</span>;   　加S锁 (共享锁)<br><span class="hljs-comment">-- 下面的都是X锁 (排它锁)</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> ? <span class="hljs-keyword">for</span> <span class="hljs-keyword">update</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">values</span> (…);<br><br><span class="hljs-keyword">update</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">set</span> ? <span class="hljs-keyword">where</span> ?;<br><br><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">where</span> ?;<br></code></pre></td></tr></table></figure>

<h6 id="3-4-4-3-场景模拟"><a href="#3-4-4-3-场景模拟" class="headerlink" title="3.4.4.3 场景模拟"></a>3.4.4.3 场景模拟</h6><p>修改事务隔离级别的语句：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">SESSION</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">REPEATABLE</span> <span class="hljs-keyword">READ</span>;  <br><span class="hljs-comment">-- READ UNCOMMITTED/READ COMMITTED/REPEATABLE READ/SERIALIZABLE</span><br></code></pre></td></tr></table></figure>

<p>（1）脏读场景模拟</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">DROP</span> TABLE <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-symbol">`employee`</span>;<br><span class="hljs-keyword">CREATE</span> TABLE <span class="hljs-symbol">`employee`</span> (<br>  <span class="hljs-symbol">`id`</span> int(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-symbol">`name`</span> varchar(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-symbol">`salary`</span> int(<span class="hljs-number">11</span>) DEFAULT <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-keyword">KEY</span> <span class="hljs-symbol">`IDX_ID`</span> (<span class="hljs-symbol">`id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>-- ----------------------------<br>-- Records of employee<br>-- ----------------------------<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;1s&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;2s&#x27;</span>, <span class="hljs-string">&#x27;20&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;30&#x27;</span>, <span class="hljs-string">&#x27;3s&#x27;</span>, <span class="hljs-string">&#x27;30&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/c8559bc8bf634a5a9d3cbb0898a46b88.jpg" srcset="/img/loading.gif" lazyload alt="57.jpg"></p>
<p>脏读场景模拟</p>
<p>（2）不可重复读模拟</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">DROP</span> TABLE <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-symbol">`employee`</span>;<br><span class="hljs-keyword">CREATE</span> TABLE <span class="hljs-symbol">`employee`</span> (<br>  <span class="hljs-symbol">`id`</span> int(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-symbol">`name`</span> varchar(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-symbol">`salary`</span> int(<span class="hljs-number">11</span>) DEFAULT <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-keyword">KEY</span> <span class="hljs-symbol">`IDX_ID`</span> (<span class="hljs-symbol">`id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br><br>-- ----------------------------<br>-- Records of employee<br>-- ----------------------------<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;1s&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;2s&#x27;</span>, <span class="hljs-string">&#x27;20&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`employee`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;30&#x27;</span>, <span class="hljs-string">&#x27;3s&#x27;</span>, <span class="hljs-string">&#x27;30&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>不可重复读的重点是修改: 同样的条件, 你读取过的数据, 再次读取出来发现值不一样了。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/00af6b4d6fc94d74b5244b5fdf04f914.jpg" srcset="/img/loading.gif" lazyload alt="58.jpg"><br>（3）幻读场景模拟</p>
<p>表结构与数据如下：id不是主键，也不是唯一索引，只是一个普通索引，事务隔离级别设置的是RR，可以模拟到GAP锁产生的场景。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">DROP</span> TABLE <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-symbol">`emp`</span>;<br><span class="hljs-keyword">CREATE</span> TABLE <span class="hljs-symbol">`emp`</span> (<br>  <span class="hljs-symbol">`id`</span> int(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-symbol">`salary`</span> int(<span class="hljs-number">11</span>) DEFAULT <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-keyword">KEY</span> <span class="hljs-symbol">`IDX_ID`</span> (<span class="hljs-symbol">`id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>-- ----------------------------<br>-- Records of emp<br>-- ----------------------------<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`emp`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;10&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`emp`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;20&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-symbol">`emp`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;30&#x27;</span>, <span class="hljs-string">&#x27;30&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>修改id&#x3D;20的数据后，会在加多个锁：20会被加X锁,[10-20],[20-30]之间会被加GAP锁。<br><img src="https://ucc.alicdn.com/pic/developer-ecology/3156e3a429a74feb9e07db605520d80d.jpg" srcset="/img/loading.gif" lazyload alt="59.jpg"><br>幻读的重点在于新增或者删除 (数据条数变化)。同样的条件, 第1次和第2次读出来的记录数不一样。</p>
<p>在标准的事务隔离级别定义下，REPEATABLE READ是不能防止幻读产生的。INNODB使用了2种技术手段（MVCC AND GAP LOCK)实现了防止幻读的发生。</p>
<h5 id="3-4-4-Innodb的多种锁"><a href="#3-4-4-Innodb的多种锁" class="headerlink" title="3.4.4 Innodb的多种锁"></a>3.4.4 Innodb的多种锁</h5><h6 id="3-4-4-1-锁类型"><a href="#3-4-4-1-锁类型" class="headerlink" title="3.4.4.1 锁类型"></a>3.4.4.1 锁类型</h6><p><img src="https://ucc.alicdn.com/pic/developer-ecology/f19f20f33b8045a280e66d068db3858d.jpg" srcset="/img/loading.gif" lazyload alt="60.jpg"></p>
<ul>
<li><p>表锁的优势：开销小；加锁快；无死锁。</p>
</li>
<li><p>表锁的劣势：锁粒度大，发生锁冲突的概率高，并发处理能力低。</p>
</li>
<li><p>加锁的方式：自动加锁。查询操作（SELECT），会自动给涉及的所有表加读锁，更新操作（UPDATE、DELETE、INSERT），会自动给涉及的表加写锁。也可以显示加锁。</p>
</li>
<li><p>共享读锁：lock table tableName read</p>
</li>
<li><p>独占写锁：lock table tableName write</p>
</li>
<li><p>批量解锁：unlock tables</p>
</li>
</ul>
<h6 id="3-4-4-2-行锁"><a href="#3-4-4-2-行锁" class="headerlink" title="3.4.4.2 行锁"></a>3.4.4.2 行锁</h6><p><img src="https://ucc.alicdn.com/pic/developer-ecology/23308b21cd724968bba51fe7e100c3a9.jpg" srcset="/img/loading.gif" lazyload alt="61.jpg"><br>只在Repeatable read和Serializable两种事务隔离级别下才会取得上面的锁。</p>
<h6 id="3-4-4-3-意向锁"><a href="#3-4-4-3-意向锁" class="headerlink" title="3.4.4.3 意向锁"></a>3.4.4.3 意向锁</h6><p>（1）场景</p>
<p>在mysql中有表锁，LOCK TABLE my_tabl_name READ; 用读锁锁表，会阻塞其他事务修改表数据。LOCK TABLE my_table_name WRITe; 用写锁锁表，会阻塞其他事务读和写。</p>
<p>Innodb引擎又支持行锁，行锁分为共享锁，一个事务对一行的共享只读锁。排它锁，一个事务对一行的排他读写锁。</p>
<p>这两中类型的锁共存的问题考虑这个例子：</p>
<p>事务A锁住了表中的一行，让这一行只能读，不能写。之后，事务B申请整个表的写锁。如果事务B申请成功，那么理论上它就能修改表中的任意一行，这与A持有的行锁是冲突的。</p>
<p>数据库需要避免这种冲突，就是说要让B的申请被阻塞，直到A释放了行锁。</p>
<p>（2）问题</p>
<p>数据库要怎么判断这个冲突呢？</p>
<p>（3）答案</p>
<p>无意向锁的情况下:</p>
<p>step1：判断表是否已被其他事务用表锁锁表</p>
<p>step2：判断表中的每一行是否已被行锁锁住。</p>
<p>有意向锁的情况下:</p>
<ul>
<li>step1：不变</li>
<li>step2：发现表上有意向共享锁，说明表中有些行被共享行锁锁住了，因此，事务B申请表的写锁会被阻塞。</li>
</ul>
<p>（4）总结</p>
<p>在无意向锁的情况下，step2需要遍历整个表,才能确认是否能拿到表锁。而在意向锁存在的情况下，事务A必须先申请表的意向共享锁，成功后再申请一行的行锁，不需要再遍历整个表，提升了效率。因此意向锁主要是为了实现多粒度锁机制（白话：为了表锁和行锁都能用）。</p>
<h6 id="3-4-4-4-X-x2F-S锁"><a href="#3-4-4-4-X-x2F-S锁" class="headerlink" title="3.4.4.4 X&#x2F;S锁"></a>3.4.4.4 X&#x2F;S锁</h6><p><img src="https://ucc.alicdn.com/pic/developer-ecology/95fe9d07bd8a4da39bd2beb2b6da6fea.jpg" srcset="/img/loading.gif" lazyload alt="62.jpg"></p>
<h6 id="3-4-4-5-一条SQL的加锁分析"><a href="#3-4-4-5-一条SQL的加锁分析" class="headerlink" title="3.4.4.5 一条SQL的加锁分析"></a>3.4.4.5 一条SQL的加锁分析</h6><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment">-- select操作均不加锁，采用的是快照读，因此在下面的讨论中就忽略了</span><br>SQL1：select * <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> <span class="hljs-built_in">id</span> = <span class="hljs-number">10</span>;<br>SQL2：delete <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> <span class="hljs-built_in">id</span> = <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>

<p>组合分为如下几种场景：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/4ede1ec485a742a7bf35c70b0e36c626.jpg" srcset="/img/loading.gif" lazyload alt="63.jpg"><br>（1）组合7的GAP锁详解读</p>
<p>Insert操作，如insert [10,aa]，首先会定位到[6,c]与[10,b]间，然后在插入前，会检查这个GAP是否已经被锁上，如果被锁上，则Insert不能插入记录。因此，通过第一遍的当前读，不仅将满足条件的记录锁上 (X锁)，与组合三类似。同时还是增加3把GAP锁，将可能插入满足条件记录的3个GAP给锁上，保证后续的Insert不能插入新的id&#x3D;10的记录，也就杜绝了同一事务的第二次当前读，出现幻象的情况。</p>
<p>既然防止幻读，需要靠GAP锁的保护，为什么组合五、组合六，也是RR隔离级别，却不需要加GAP锁呢？</p>
<p>GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况。而组合五，id是主键；组合六，id是unique键，都能够保证唯一性。</p>
<p>一个等值查询，最多只能返回一条记录，而且新的相同取值的记录，一定不会在新插入进来，因此也就避免了GAP锁的使用。</p>
<p>（2）结论</p>
<ul>
<li><p>Repeatable Read隔离级别下，id列上有一个非唯一索引，对应SQL：delete from t1 where id &#x3D; 10; 首先，通过id索引定位到第一条满足查询条件的记录，加记录上的X锁，加GAP上的GAP锁，然后加主键聚簇索引上的记录X锁，然后返回；然后读取下一条，重复进行。直至进行到第一条不满足条件的记录[11,f]，此时，不需要加记录X锁，但是仍旧需要加GAP锁，最后返回结束。</p>
</li>
<li><p>什么时候会取得gap lock或nextkey lock 这和隔离级别有关,只在REPEATABLE READ或以上的隔离级别下的特定操作才会取得gap lock或nextkey lock。</p>
</li>
</ul>
<h5 id="3-4-5-线上问题处理"><a href="#3-4-5-线上问题处理" class="headerlink" title="3.4.5 线上问题处理"></a>3.4.5 线上问题处理</h5><h6 id="3-4-5-1-观察问题的几个常见库表"><a href="#3-4-5-1-观察问题的几个常见库表" class="headerlink" title="3.4.5.1 观察问题的几个常见库表"></a>3.4.5.1 观察问题的几个常见库表</h6><p>首先可以通过下属两个命令来查看mysql的相应的系统变量和状态变量。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"># status代表当前系统的运行状态，只能查看，不能修改<br><span class="hljs-keyword">show</span> status <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%abc%&#x27;</span>;<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%abc%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>MySQL 5.7.6开始后改成了从如下表获取：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">performance_schema<span class="hljs-selector-class">.global_variables</span> <br>performance_schema<span class="hljs-selector-class">.session_variables</span> <br>performance_schema<span class="hljs-selector-class">.variables_by_thread</span> <br>performance_schema<span class="hljs-selector-class">.global_status</span> <br>performance_schema<span class="hljs-selector-class">.session_status</span> <br>performance_schema<span class="hljs-selector-class">.status_by_thread</span> <br>performance_schema<span class="hljs-selector-class">.status_by_account</span> <br>performance_schema<span class="hljs-selector-class">.status_by_host</span> <br>performance_schema.status_by_user<br></code></pre></td></tr></table></figure>

<p>之前是从如下表获取：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">INFORMATION_SCHEMA<span class="hljs-selector-class">.GLOBAL_VARIABLES</span> <br>INFORMATION_SCHEMA<span class="hljs-selector-class">.SESSION_VARIABLES</span> <br>INFORMATION_SCHEMA<span class="hljs-selector-class">.GLOBAL_STATUS</span> <br>INFORMATION_SCHEMA.SESSION_STATUS<br></code></pre></td></tr></table></figure>

<p>比较常用的系统变量和状态变量有：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 查询慢<span class="hljs-keyword">SQL</span>查询是否开启<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;slow_query_log&#x27;</span>;<br># 查询慢<span class="hljs-keyword">SQL</span>的时间<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;long_query_time&#x27;</span>;<br># 查看慢<span class="hljs-keyword">SQL</span>存放路径，一般：/home/mysql/data3016/mysql/slow_query.<span class="hljs-keyword">log</span><br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;slow_query_log_file&#x27;</span>;<br><br># 查看数据库的事务隔离级别,RDS:<span class="hljs-keyword">READ</span>-<span class="hljs-keyword">COMMITTED</span>   Mysql:<span class="hljs-keyword">Repeatable</span> <span class="hljs-keyword">read</span><br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;tx_isolation&#x27;</span>; <br> # innodb数据页大小  <span class="hljs-number">16384</span><br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;innodb_page_size&#x27;</span>; <br><br><span class="hljs-keyword">show</span> status  <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;innodb_row_%&#x27;</span>;<br><br># 查看慢<span class="hljs-keyword">SQL</span><br><span class="hljs-keyword">SHOW</span> SLOW <span class="hljs-keyword">limit</span> <span class="hljs-number">10</span>;<br><span class="hljs-keyword">show</span> <span class="hljs-keyword">full</span> slow <span class="hljs-keyword">limit</span> <span class="hljs-number">10</span>;<br><br># 查看autocommit配置<br><span class="hljs-keyword">select</span> @@autocommit; <br> # 同上<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;autocommit&#x27;</span>; <br>#设置<span class="hljs-keyword">SQL</span>自动提交模式  <span class="hljs-number">1</span>:默认,自动提交   <span class="hljs-number">0</span>:需要手动触发<span class="hljs-keyword">commit</span>,否则不会生效<br><span class="hljs-keyword">set</span> autocommit=<span class="hljs-number">1</span>;　　<br># 查看默认的搜索引擎<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%storage_engine%&#x27;</span>; <br><br># 设置事务隔离级别<br><span class="hljs-keyword">SET</span> <span class="hljs-keyword">SESSION</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">REPEATABLE</span> <span class="hljs-keyword">READ</span>;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-一些建议"><a href="#3-5-一些建议" class="headerlink" title="3.5 一些建议"></a>3.5 一些建议</h4><h5 id="3-5-1-小表驱动大表"><a href="#3-5-1-小表驱动大表" class="headerlink" title="3.5.1 小表驱动大表"></a>3.5.1 小表驱动大表</h5><ul>
<li>nb_soft_nature：小表</li>
<li>nb_soft：大表</li>
<li>package_name：都是索引</li>
</ul>
<p>MySQL 表关联的算法是Nest Loop Join(嵌套循环连接)，是通过驱动表的结果集作为循环基础数据，然后一条一条地通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果。</p>
<p>（1）小表驱动大表<br><img src="https://ucc.alicdn.com/pic/developer-ecology/8fbaab9f7ce441ab945cc019dd38d084.jpg" srcset="/img/loading.gif" lazyload alt="64.jpg"><br>nb_soft_nature 中只有24条数据，每条数据的package_name连接到nb_soft表中做查询，由于package_name在nb_soft表中有索引，因此一共只需要24次扫描即可。</p>
<p>（2）大表驱动小表<br><img src="https://ucc.alicdn.com/pic/developer-ecology/6188023b36644b088b5d46363d786005.jpg" srcset="/img/loading.gif" lazyload alt="65.jpg"><br>同上，需要100多万次扫描才能返回结果</p>
<h5 id="3-5-2-使用自增长主键"><a href="#3-5-2-使用自增长主键" class="headerlink" title="3.5.2 使用自增长主键"></a>3.5.2 使用自增长主键</h5><p>结合B+Tree的特点，自增主键是连续的，在插入过程中尽量减少页分裂，即使要进行页分裂，也只会分裂很少一部分。并且能减少数据的移动，每次插入都是插入到最后。总之就是减少分裂和移动的频率。</p>
<h3 id="四-Redis"><a href="#四-Redis" class="headerlink" title="四 Redis"></a>四 Redis</h3><h4 id="4-1-问题处理思路"><a href="#4-1-问题处理思路" class="headerlink" title="4.1 问题处理思路"></a>4.1 问题处理思路</h4><p><img src="https://ucc.alicdn.com/pic/developer-ecology/c6d9461ae67a448681e19cb16ff19e80.jpg" srcset="/img/loading.gif" lazyload alt="66.jpg"></p>
<h4 id="4-2-内存告警"><a href="#4-2-内存告警" class="headerlink" title="4.2 内存告警"></a>4.2 内存告警</h4><p>时常会出现下述异常提示信息：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery">OOM command<span class="hljs-built_in"> not</span> allowed <span class="hljs-keyword">when</span> used memory<br></code></pre></td></tr></table></figure>

<h5 id="4-2-1-设置合理的内存大小"><a href="#4-2-1-设置合理的内存大小" class="headerlink" title="4.2.1 设置合理的内存大小"></a>4.2.1 设置合理的内存大小</h5><p>设置maxmemory和相对应的回收策略算法，设置最好为物理内存的3&#x2F;4，或者比例更小，因为redis复制数据等其他服务时，也是需要缓存的。以防缓存数据过大致使redis崩溃，造成系统出错不可用。</p>
<p>（1）通过redis.conf 配置文件指定</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">maxmemory xxxxxx</span><br></code></pre></td></tr></table></figure>

<p>（2）通过命令修改</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">config set  maxmemory xxxxx<br></code></pre></td></tr></table></figure>

<h5 id="4-2-2-设置合理的内存淘汰策略"><a href="#4-2-2-设置合理的内存淘汰策略" class="headerlink" title="4.2.2 设置合理的内存淘汰策略"></a>4.2.2 设置合理的内存淘汰策略</h5><p><img src="https://ucc.alicdn.com/pic/developer-ecology/fe51c527f7464b7e988db4a02940d2b8.jpg" srcset="/img/loading.gif" lazyload alt="67.jpg"><br>（1）通过redis.conf 配置文件指定</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">maxmemory-<span class="hljs-keyword">policy</span> allkeys-lru<br></code></pre></td></tr></table></figure>

<h5 id="4-2-3-查看大key"><a href="#4-2-3-查看大key" class="headerlink" title="4.2.3 查看大key"></a>4.2.3 查看大key</h5><p>（1）有工具的情况下:</p>
<p>安装工具dbatools redisTools,列出最大的前N个key</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-regexp">/data/</span>program<span class="hljs-regexp">/dbatools-master/</span>redisTools/redis-cli-<span class="hljs-keyword">new</span> -h &lt;ip&gt; -p &lt;port&gt; --bigkeys --bigkey-numb <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p>得到如下结果:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vim">Sampled <span class="hljs-number">122114</span> <span class="hljs-built_in">keys</span> in the keyspace!<br>Total key length in bytes <span class="hljs-keyword">is</span> <span class="hljs-number">3923725</span> (avg <span class="hljs-built_in">len</span> <span class="hljs-number">32.13</span>)<br><br><br>Biggest <span class="hljs-built_in">string</span> Key Top   <span class="hljs-number">1</span>  found <span class="hljs-string">&#x27;xx1&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">36316</span> bytes<br>Biggest <span class="hljs-built_in">string</span> Key Top   <span class="hljs-number">2</span>  found <span class="hljs-string">&#x27;xx2&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">1191</span> bytes<br>Biggest <span class="hljs-built_in">string</span> Key Top   <span class="hljs-number">3</span>  found <span class="hljs-string">&#x27;xx3&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">234</span> bytes<br>Biggest   <span class="hljs-keyword">list</span> Key Top   <span class="hljs-number">1</span>  found <span class="hljs-string">&#x27;x4&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">204480</span> <span class="hljs-built_in">items</span><br>Biggest   <span class="hljs-keyword">list</span> Key Top   <span class="hljs-number">2</span>  found <span class="hljs-string">&#x27;x5&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">119999</span> <span class="hljs-built_in">items</span><br>Biggest   <span class="hljs-keyword">list</span> Key Top   <span class="hljs-number">3</span>  found <span class="hljs-string">&#x27;x6&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">60000</span> <span class="hljs-built_in">items</span><br>Biggest    <span class="hljs-keyword">set</span> Key Top   <span class="hljs-number">1</span>  found <span class="hljs-string">&#x27;x7&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">14205</span> members<br>Biggest    <span class="hljs-keyword">set</span> Key Top   <span class="hljs-number">2</span>  found <span class="hljs-string">&#x27;x8&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">292</span> members<br>Biggest    <span class="hljs-keyword">set</span> Key Top   <span class="hljs-number">3</span>  found <span class="hljs-string">&#x27;x,7&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">21</span> members<br>Biggest   hash Key Top   <span class="hljs-number">1</span>  found <span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">302939</span> fields<br>Biggest   hash Key Top   <span class="hljs-number">2</span>  found <span class="hljs-string">&#x27;xc&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">92029</span> fields<br>Biggest   hash Key Top   <span class="hljs-number">3</span>  found <span class="hljs-string">&#x27;xd&#x27;</span> <span class="hljs-built_in">has</span> <span class="hljs-number">39634</span> fields<br></code></pre></td></tr></table></figure>

<p>原生命令为：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/redis-3.0.5/</span>src/redis-cli -c -h &lt;ip&gt; -p &lt;port&gt; --bigkeys<br></code></pre></td></tr></table></figure>

<p>分析rdb文件中的全部key&#x2F;某种类型的占用量：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">rdb -c memory <span class="hljs-keyword">dump</span>.rdb -t list -f <span class="hljs-keyword">dump</span>-formal-list.csv<br></code></pre></td></tr></table></figure>

<p>查看某个key的内存占用量：</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs julia">[root<span class="hljs-meta">@iZbp16umm14vm5kssepfdpZ</span> redisTools]<span class="hljs-comment"># redis-memory-for-key  -s &lt;ip&gt; -p &lt;port&gt; x</span><br>Key             x<br>Bytes               <span class="hljs-number">4274388.0</span><br><span class="hljs-built_in">Type</span>                hash<br>Encoding            hashtable<br><span class="hljs-built_in">Number</span> of Elements      <span class="hljs-number">39634</span><br>Length of Largest Element   <span class="hljs-number">29</span><br></code></pre></td></tr></table></figure>

<p>（2）无工具的情况下可利用以下指令评估key大小：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">debug</span> object <span class="hljs-built_in">key</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-Redis的慢命令"><a href="#4-3-Redis的慢命令" class="headerlink" title="4.3 Redis的慢命令"></a>4.3 Redis的慢命令</h4><h5 id="4-3-1-设置Redis的慢命令的时间阈值-单位：微妙"><a href="#4-3-1-设置Redis的慢命令的时间阈值-单位：微妙" class="headerlink" title="4.3.1 设置Redis的慢命令的时间阈值(单位：微妙)"></a>4.3.1 设置Redis的慢命令的时间阈值(单位：微妙)</h5><p>（1）通过redis.conf配置文件方式</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment"># 执行时间大于多少微秒(microsecond，1秒 = 1,000,000 微秒)的查询进行记录。</span><br>slowlog-<span class="hljs-built_in">log</span>-<span class="hljs-built_in">lower</span>-than <span class="hljs-number">1000</span><br><br><span class="hljs-comment"># 最多能保存多少条日志</span><br>slowlog-<span class="hljs-built_in">max</span>-<span class="hljs-built_in">len</span> <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure>

<p>（2）通过命令方式</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment"># 配置查询时间超过1毫秒的， 第一个参数单位是微秒</span><br>config <span class="hljs-built_in">set</span> slowlog-<span class="hljs-built_in">log</span>-<span class="hljs-built_in">lower</span>-than <span class="hljs-number">1000</span><br><br><span class="hljs-comment"># 保存200条慢查记录</span><br>config <span class="hljs-built_in">set</span> slowlog-<span class="hljs-built_in">max</span>-<span class="hljs-built_in">len</span> <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure>

<h5 id="4-3-2-查看Redis的慢命令"><a href="#4-3-2-查看Redis的慢命令" class="headerlink" title="4.3.2 查看Redis的慢命令"></a>4.3.2 查看Redis的慢命令</h5><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">slowlog <span class="hljs-keyword">get</span><br></code></pre></td></tr></table></figure>

<h4 id="4-4-连接过多"><a href="#4-4-连接过多" class="headerlink" title="4.4 连接过多"></a>4.4 连接过多</h4><p>（1）通过redis.conf 配置文件指定最大连接数</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">maxclients</span> <span class="hljs-number">10000</span><br></code></pre></td></tr></table></figure>

<p>（2）通过命令修改</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">config set maxclients xxx<br></code></pre></td></tr></table></figure>

<h4 id="4-5-线上Redis节点挂掉一个之后的处理流程"><a href="#4-5-线上Redis节点挂掉一个之后的处理流程" class="headerlink" title="4.5 线上Redis节点挂掉一个之后的处理流程"></a>4.5 线上Redis节点挂掉一个之后的处理流程</h4><h5 id="4-5-1-查看节点状态"><a href="#4-5-1-查看节点状态" class="headerlink" title="4.5.1 查看节点状态"></a>4.5.1 查看节点状态</h5><p>执行 cluster nodes 后发现会有一个节点dead：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[rgp@iZ23rjcqbczZ ~]$ /data/program/redis-<span class="hljs-number">3.0</span>.<span class="hljs-number">3</span>/bin/redis-cli -c -h <span class="hljs-tag">&lt;ip&gt;</span> -p <span class="hljs-tag">&lt;port&gt;</span><br>ip:port&gt; cluster nodes<br><span class="hljs-number">9</span>f194f671cee4a76ce3b7ff14d3bda190e0695d5 m1 <span class="hljs-keyword">master</span> <span class="hljs-title">- 0</span> <span class="hljs-number">1550322872543</span> <span class="hljs-number">65</span> connected <span class="hljs-number">10923</span>-<span class="hljs-number">16383</span><br>a38c6f957f2706f269cf5d9b628586a9372265e9 s1 <span class="hljs-literal">slave</span> <span class="hljs-number">9</span>f194f671cee4a76ce3b7ff14d3bda190e0695d5 <span class="hljs-number">0</span> <span class="hljs-number">1550322872943</span> <span class="hljs-number">65</span> connected<br><span class="hljs-number">77</span>ce43ec23f25f77ec68fe71ae3cb799e7300c6d s2 <span class="hljs-literal">slave</span> <span class="hljs-number">03</span>d72a3a5050c85e280e0bbeb687056b84f10077 <span class="hljs-number">0</span> <span class="hljs-number">1550322873543</span> <span class="hljs-number">63</span> connected<br><span class="hljs-number">03</span>d72a3a5050c85e280e0bbeb687056b84f10077 m2 <span class="hljs-keyword">master</span> <span class="hljs-title">- 0</span> <span class="hljs-number">1550322873343</span> <span class="hljs-number">63</span> connected <span class="hljs-number">5461</span>-<span class="hljs-number">10922</span><br><span class="hljs-number">5799070</span>c6a63314296f3661b315b95c6328779f7 :<span class="hljs-number">0</span> <span class="hljs-literal">slave</span>,fail,noaddr <span class="hljs-number">6147</span>bf416ef216b6a1ef2f100d15de4f439b7352 <span class="hljs-number">1550320811474</span> <span class="hljs-number">1550320808793</span> <span class="hljs-number">49</span> disconnected<br><span class="hljs-number">6147</span>bf416ef216b6a1ef2f100d15de4f439b7352 m3 myself,<span class="hljs-keyword">master</span> <span class="hljs-title">- 0</span> <span class="hljs-number">0</span> <span class="hljs-number">49</span> connected <span class="hljs-number">0</span>-<span class="hljs-number">5460</span><br></code></pre></td></tr></table></figure>

<h5 id="4-5-2-移除错误节点"><a href="#4-5-2-移除错误节点" class="headerlink" title="4.5.2 移除错误节点"></a>4.5.2 移除错误节点</h5><p>（1）一开始执行如下的删除操作失败，需要针对于每一个节点都执行 cluster forget：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">ip:port&gt; <span class="hljs-keyword">cluster</span> forget <span class="hljs-number">61</span>c70a61ad91bbac231e33352f5bdb9eb0be6289<br><span class="hljs-keyword">CLUSTER</span> FORGET &lt;node_id&gt; 从集群中移除 node_id 指定的节点<br></code></pre></td></tr></table></figure>

<p>（2）删除挂掉的节点：</p>
<figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python-repl">[rgp@iZ23rjcqbczZ ~]$ /data/program/redis-3.0.3/bin/redis-trib.rb del-node m3 b643d7baa69922b3fdbd1e25ccbe6ed73587b948<br><span class="hljs-meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">Removing node b643d7baa69922b3fdbd1e25ccbe6ed73587b948 <span class="hljs-keyword">from</span> cluster m3</span><br><span class="hljs-meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">Sending CLUSTER FORGET messages to the cluster...</span><br><span class="hljs-meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">SHUTDOWN the node.</span><br></code></pre></td></tr></table></figure>

<p>（3）清理掉节点配置目录下的rdb aof nodes.conf 等文件，否则节点的启动会有如下异常：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery">[ERR] Node s3 <span class="hljs-literal">is</span><span class="hljs-built_in"> not</span><span class="hljs-built_in"> empty</span>. Either the <span class="hljs-type">node</span> already knows other nodes (check with CLUSTER NODES) <span class="hljs-keyword">or</span><span class="hljs-built_in"> contains</span> <span class="hljs-keyword">some</span><span class="hljs-built_in"> key</span> <span class="hljs-keyword">in</span> database <span class="hljs-number">0</span>.<br></code></pre></td></tr></table></figure>

<h5 id="4-5-3-恢复节点"><a href="#4-5-3-恢复节点" class="headerlink" title="4.5.3 恢复节点"></a>4.5.3 恢复节点</h5><p>（1）后台启动Redis某个节点：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/data/</span>program<span class="hljs-regexp">/redis-3.0.3/</span>bin<span class="hljs-regexp">/redis-server /</span>data<span class="hljs-regexp">/program/</span>redis-<span class="hljs-number">3.0</span>.<span class="hljs-number">3</span><span class="hljs-regexp">/etc/</span><span class="hljs-number">7001</span>/redis.conf &amp;<br></code></pre></td></tr></table></figure>

<p>（2）将该节点添加进集群：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@iZ23rjcqbczZ rgp]<span class="hljs-comment"># /data/program/redis-3.0.3/bin/redis-trib.rb add-node  --slave --master-id 6147bf416ef216b6a1ef2f100d15de4f439b7352 s3 m3</span><br>&gt;&gt;&gt; Adding <span class="hljs-keyword">node</span> <span class="hljs-title">s3</span> to cluster m3<br>&gt;&gt;&gt; Performing Cluster Check (using <span class="hljs-keyword">node</span> <span class="hljs-title">m3</span>)<br>M: <span class="hljs-number">6147</span>bf416ef216b6a1ef2f100d15de4f439b7352 m3<br>   slots:<span class="hljs-number">0</span>-<span class="hljs-number">5460</span> (<span class="hljs-number">5461</span> slots) <span class="hljs-keyword">master</span><br>   <span class="hljs-title">0</span> additional replica(s)<br>M: <span class="hljs-number">9</span>f194f671cee4a76ce3b7ff14d3bda190e0695d5 m1<br>   slots:<span class="hljs-number">10923</span>-<span class="hljs-number">16383</span> (<span class="hljs-number">5461</span> slots) <span class="hljs-keyword">master</span><br>   <span class="hljs-title">1</span> additional replica(s)<br>S: a38c6f957f2706f269cf5d9b628586a9372265e9 s1<br>   slots: (<span class="hljs-number">0</span> slots) <span class="hljs-literal">slave</span><br>   replicates <span class="hljs-number">9</span>f194f671cee4a76ce3b7ff14d3bda190e0695d5<br>S: <span class="hljs-number">77</span>ce43ec23f25f77ec68fe71ae3cb799e7300c6d s2<br>   slots: (<span class="hljs-number">0</span> slots) <span class="hljs-literal">slave</span><br>   replicates <span class="hljs-number">03</span>d72a3a5050c85e280e0bbeb687056b84f10077<br>M: <span class="hljs-number">03</span>d72a3a5050c85e280e0bbeb687056b84f10077 m2<br>   slots:<span class="hljs-number">5461</span>-<span class="hljs-number">10922</span> (<span class="hljs-number">5462</span> slots) <span class="hljs-keyword">master</span><br>   <span class="hljs-title">1</span> additional replica(s)<br>[OK] All nodes agree about slots configuration.<br>&gt;&gt;&gt; Check for open slots...<br>&gt;&gt;&gt; Check slots coverage...<br>[OK] All <span class="hljs-number">16384</span> slots covered.<br>&gt;&gt;&gt; Send CLUSTER MEET to <span class="hljs-keyword">node</span> <span class="hljs-title">s3</span> to make it join the cluster.<br>Waiting for the cluster to join..<br>&gt;&gt;&gt; Configure <span class="hljs-keyword">node</span> <span class="hljs-title">as</span> replica of m3.<br>[OK] New <span class="hljs-keyword">node</span> <span class="hljs-title">added</span> correctly.<br></code></pre></td></tr></table></figure>

<ul>
<li>s3:本次待添加的从节点ip：port</li>
<li>m3:主节点的ip：port</li>
<li>6147bf416ef216b6a1ef2f100d15de4f439b7352：主节点编号</li>
</ul>
<h3 id="五-网络"><a href="#五-网络" class="headerlink" title="五 网络"></a>五 网络</h3><h4 id="5-1-排查流程"><a href="#5-1-排查流程" class="headerlink" title="5.1 排查流程"></a>5.1 排查流程</h4><h5 id="5-1-1-现象出现"><a href="#5-1-1-现象出现" class="headerlink" title="5.1.1 现象出现"></a>5.1.1 现象出现</h5><p>在非压测或者高峰期的情况下，突然出现大量的503等错误码，页面无法打开。</p>
<h5 id="5-1-2-查看是否遭受了DOS攻击"><a href="#5-1-2-查看是否遭受了DOS攻击" class="headerlink" title="5.1.2 查看是否遭受了DOS攻击"></a>5.1.2 查看是否遭受了DOS攻击</h5><p>当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了，使用如下命令可以让之现行。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">netstat -n<span class="hljs-string">|grep SYN_RECV</span><br></code></pre></td></tr></table></figure>

<h5 id="5-1-3-查看TCP连接状态"><a href="#5-1-3-查看TCP连接状态" class="headerlink" title="5.1.3 查看TCP连接状态"></a>5.1.3 查看TCP连接状态</h5><p>首先利用以下查看tcp总连接数，判断连接数是否正常：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">netstat</span> -anoe|grep <span class="hljs-number">8000</span>|wc -l 查看<span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure>

<p>然后利用如下命令判断各个状态的连接数是否正常：</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">netstat -n | awk &#x27;/<span class="hljs-symbol">^tcp</span>/ &#123;++<span class="hljs-keyword">S</span>[<span class="hljs-built_in">$NF</span>]&#125; END &#123;<span class="hljs-keyword">for</span>(a in <span class="hljs-keyword">S</span>) <span class="hljs-keyword">print</span> a, <span class="hljs-keyword">S</span>[a]&#125;&#x27;<br></code></pre></td></tr></table></figure>

<p>根据上述信息，如果TIME_WAIT 状态数量过多，可利用如下命令查看连接CLOSE_WAIT最多的IP地址，再结合业务分析问题：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">netstat -n|<span class="hljs-type">grep</span> TIME_WAIT|<span class="hljs-type">awk</span> &#x27;&#123;print $<span class="hljs-number">5</span>&#125;&#x27;|<span class="hljs-type">awk</span> -F: &#x27;&#123;print $<span class="hljs-number">1</span>&#125;&#x27;|<span class="hljs-type">sort</span>|<span class="hljs-type">uniq</span> -c|<span class="hljs-type">sort</span> -nr|<span class="hljs-type">head</span> <span class="hljs-number">-10</span><br></code></pre></td></tr></table></figure>

<h4 id="5-2-相关知识"><a href="#5-2-相关知识" class="headerlink" title="5.2 相关知识"></a>5.2 相关知识</h4><h5 id="5-2-1-TCP连接"><a href="#5-2-1-TCP连接" class="headerlink" title="5.2.1 TCP连接"></a>5.2.1 TCP连接</h5><p>TCP三次握手四次挥手<br><img src="https://ucc.alicdn.com/pic/developer-ecology/c83c2db22d2e4a0493919fa7252caf73.jpg" srcset="/img/loading.gif" lazyload alt="68.jpg"><br>为什么在第3步中客户端还要再进行一次确认呢？这主要是为了防止已经失效的连接请求报文段突然又传回到服务端而产生错误的场景：</p>
<p>所谓”已失效的连接请求报文段”是这样产生的。正常来说，客户端发出连接请求，但因为连接请求报文丢失而未收到确认。于是客户端再次发出一次连接请求，后来收到了确认，建立了连接。数据传输完毕后，释放了连接，客户端一共发送了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，没有”已失效的连接请求报文段”。</p>
<p>现在假定一种异常情况，即客户端发出的第一个连接请求报文段并没有丢失，只是在某些网络节点长时间滞留了，以至于延误到连接释放以后的某个时间点才到达服务端。本来这个连接请求已经失效了，但是服务端收到此失效的连接请求报文段后，就误认为这是客户端又发出了一次新的连接请求。于是服务端又向客户端发出请求报文段，同意建立连接。假定不采用三次握手，那么只要服务端发出确认，连接就建立了。</p>
<p>由于现在客户端并没有发出连接建立的请求，因此不会理会服务端的确认，也不会向服务端发送数据，但是服务端却以为新的传输连接已经建立了，并一直等待客户端发来数据，这样服务端的许多资源就这样白白浪费了。</p>
<p>采用三次握手的办法可以防止上述现象的发生。比如在上述的场景下，客户端不向服务端的发出确认请求，服务端由于收不到确认，就知道客户端并没有要求建立连接。</p>
<p>SYN攻击时一种典型的DDOS攻击，检测SYN攻击的方式非常简单，即当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了，使用如下命令可以让之现行：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">netstat -nap <span class="hljs-string">| grep SYN_RECV</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/619d76fb0d304246a02276af64e8ea25.jpg" srcset="/img/loading.gif" lazyload alt="69.jpg"></p>
<h5 id="5-2-2-一些常见问题"><a href="#5-2-2-一些常见问题" class="headerlink" title="5.2.2 一些常见问题"></a>5.2.2 一些常见问题</h5><p>（1）为什么TCP连接的建立只需要三次握手而TCP连接的释放需要四次握手呢?</p>
<p>因为服务端在LISTEN状态下，收到建立请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。而连接关闭时，当收到对方的FIN报文时，仅仅表示对方没有需要发送的数据了，但是还能接收数据，己方未必数据已经全部发送给对方了，所以己方可以立即关闭，也可以将应该发送的数据全部发送完毕后再发送FIN报文给客户端来表示同意现在关闭连接。</p>
<p>从这个角度而言，服务端的ACK和FIN一般都会分开发送。</p>
<p>（2）如果已经建立了连接，但是客户端突然出现故障了怎么办？</p>
<p>TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。</p>
<p>（3）为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</p>
<p>虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，有可以最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。</p>
<p>在Client发送出最后的ACK回复，但该ACK可能丢失。Server如果没有收到ACK，将不断重复发送FIN片段。所以Client不能立即关闭，它必须确认Server接收到了该ACK。Client会在发送出ACK之后进入到TIME_WAIT状态。Client会设置一个计时器，等待2MSL的时间。如果在该时间内再次收到FIN，那么Client会重发ACK并再次等待2MSL。所谓的2MSL是两倍的MSL(Maximum Segment Lifetime)。</p>
<p>MSL指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，那么Client推断ACK已经被成功接收，则结束TCP连接。</p>
<h3 id="六-业务异常日志"><a href="#六-业务异常日志" class="headerlink" title="六 业务异常日志"></a>六 业务异常日志</h3><h4 id="6-1-问题出现"><a href="#6-1-问题出现" class="headerlink" title="6.1 问题出现"></a>6.1 问题出现</h4><p>主要是通过业务日志监控主动报警或者是查看错误日志被动发现：<br><img src="https://ucc.alicdn.com/pic/developer-ecology/728cfb1e692746b185b3ecb6ef10127b.jpg" srcset="/img/loading.gif" lazyload alt="70.jpg"></p>
<h4 id="6-2-日志分析"><a href="#6-2-日志分析" class="headerlink" title="6.2 日志分析"></a>6.2 日志分析</h4><h5 id="6-2-1-确认日志格式"><a href="#6-2-1-确认日志格式" class="headerlink" title="6.2.1 确认日志格式"></a>6.2.1 确认日志格式</h5><p>日志格式如下：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;METRICS_LOG_PATTERN&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d</span></span></span><span class="hljs-template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|$</span></span></span><span class="hljs-template-variable">&#123;APP_NAME&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;className&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;methodName&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;responseStatus&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;timeConsume&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;traceId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;errorCode&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%msg%n&quot;</span>/&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ERROR_LOG_PATTERN&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d</span></span></span><span class="hljs-template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%-5level|%X</span></span></span><span class="hljs-template-variable">&#123;traceId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|$</span></span></span><span class="hljs-template-variable">&#123;APP_NAME&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%serverIp|%X</span></span></span><span class="hljs-template-variable">&#123;tenantId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;accountId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%thread|%logger</span></span></span><span class="hljs-template-variable">&#123;30&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%msg%n&quot;</span>/&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-comment">&lt;!--日志格式 时间|级别|链路id|应用名|服务器ip|租户id|用户id|线程名称|logger名称|业务消息 --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;BIZ_LOG_PATTERN&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%d</span></span></span><span class="hljs-template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%-5level|%X</span></span></span><span class="hljs-template-variable">&#123;traceId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|$</span></span></span><span class="hljs-template-variable">&#123;APP_NAME&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%serverIp|%X</span></span></span><span class="hljs-template-variable">&#123;tenantId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%X</span></span></span><span class="hljs-template-variable">&#123;accountId&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%thread|%logger</span></span></span><span class="hljs-template-variable">&#123;30&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">|%msg%n&quot;</span>/&gt;</span></span><br></code></pre></td></tr></table></figure>

<h5 id="6-2-2-在日志文件中检索异常"><a href="#6-2-2-在日志文件中检索异常" class="headerlink" title="6.2.2 在日志文件中检索异常"></a>6.2.2 在日志文件中检索异常</h5><p>利用如下命令可获得异常的详细信息：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">cat</span> <span class="hljs-keyword">error</span>.<span class="hljs-keyword">log</span>|grep -<span class="hljs-keyword">n</span> <span class="hljs-string">&quot; java.lang.reflect.InvocationTargetException&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/7fe0552062814b36bbe6e97f005c1388.jpg" srcset="/img/loading.gif" lazyload alt="71.jpg"><br>根据日志格式和日志信息，可获得traceId为489d71fe-67db-4f59-a916-33f25d35cab8，然后利用以下指令获取整个流程的日志信息：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cat</span> biz.log |grep -n &#x27;<span class="hljs-number">489</span>d71fe-<span class="hljs-number">67</span>db-<span class="hljs-number">4</span>f59-a916-<span class="hljs-number">33</span>f25d35cab8&#x27;<br></code></pre></td></tr></table></figure>

<p><img src="https://ucc.alicdn.com/pic/developer-ecology/d173857d6adc48d09954780f5b5cee18.jpg" srcset="/img/loading.gif" lazyload alt="72.jpg"></p>
<h5 id="6-2-3-代码分析"><a href="#6-2-3-代码分析" class="headerlink" title="6.2.3 代码分析"></a>6.2.3 代码分析</h5><p>然后根据上述流程日志找到对应的代码实现，然后进行具体的业务分析。</p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/09-%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/" class="category-chain-item">09_调试测试</a>
  
  
    <span>></span>
    
  <a href="/categories/09-%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/05-%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/" class="category-chain-item">05_线上问题</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">#问题排查</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>01-线上问题快速排查思路</div>
      <div>https://janycode.github.io/2020/11/17/09_调试测试/05_线上问题/01-线上问题快速排查思路/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Jerry(姜源)</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年11月17日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 姜源">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/27/15_%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1/01_%E4%B8%9A%E5%8A%A1%E8%AE%BE%E8%AE%A1/02-%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/11/15/04_%E7%BD%91%E9%A1%B5%E6%8A%80%E6%9C%AF/06_JavaScript/13-JS%20%E5%AF%BC%E5%87%BA%E5%B0%8F%E7%B1%B3%E4%BE%BF%E7%AD%BE%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%E5%88%B0%E8%8B%B9%E6%9E%9C%E6%89%8B%E6%9C%BA/" title="13-JS 导出小米便签所有内容到苹果手机">
                        <span class="hidden-mobile">13-JS 导出小米便签所有内容到苹果手机</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="SOHUCS" sid='https://janycode.github.io/2020/11/17/09_%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/05_%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/01-%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%BF%AB%E9%80%9F%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/'></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#SOHUCS', function() {
      Fluid.utils.createScript("https://changyan.sohu.com/upload/changyan.js", function() {
        window.changyan.api.config({"appid":"cyw5OHIcO","appkey":"fea3446b3df4b3f129f34da4cbc87e51"})
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://simple.blog.csdn.net" target="_blank" rel="nofollow noopener"><span>CSDN</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/janycode" target="_blank" rel="nofollow noopener"><span>GitHub</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量(PV) 
        <span id="busuanzi_value_site_pv"></span>
         次，
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数(UV) 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

<!-- live2d 动画 -->
<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script>
<script>
    L2Dwidget.init({
        "model": {
            jsonPath: "https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
            "scale": 1
        },
        "display": {
            "position": "right",
            "width": 100,
            "height": 200,
            "hOffset": 35,
            "vOffset": -85
        },
        "mobile": {
            "show": false,
            "scale": 0.1
        },
        "react": {
            "opacityDefault": 0.75,
            "opacityOnHover": 0.2
        }
    });
</script>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?bfff735c897eb60ea49b735096b20e47";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
